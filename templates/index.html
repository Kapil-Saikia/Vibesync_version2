<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ec4899" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>VibeSync â€” Emotion-Based Music</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="/static/js/shared-player.js"></script>
  <style>
    @import url('/static/css/vibesync-theme.css');
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #151925;
      --bg-tertiary: #1e2435;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #ec4899;
      --accent-secondary: #db2777;
      --accent-tertiary: #be185d;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-hero: linear-gradient(135deg, #667eea 0%, #ec4899 50%, #f97316 100%);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.2);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.3);
      --shadow-xl: 0 20px 60px rgba(0,0,0,0.4);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --blur: blur(20px);
    }
    
    body.light {
      --bg-primary: #f1f5f9;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --shadow-xl: 0 20px 60px rgba(0,0,0,0.15);
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #0f1419 50%, #0a0e1a 100%);
      background-attachment: fixed;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: -0.01em;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    /* NAVBAR */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 28px;
      background: rgba(21, 25, 37, 0.85);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      transition: all 0.3s ease;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
    }

    .menu-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-primary);
      border-radius: var(--radius-md);
      transition: var(--transition);
    }
    
    .menu-icon:hover {
      background: rgba(255,255,255,0.08);
      transform: scale(1.05);
    }
    
    .menu-icon:active {
      transform: scale(0.95);
    }

    .search-bar {
      position: relative;
      flex: 1;
      max-width: 500px;
    }
    
    .search-bar input {
      padding: 14px 22px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,0.1);
      outline: none;
      background: rgba(30, 36, 53, 0.8);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      width: 100%;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .search-bar input:focus {
      border-color: var(--accent-primary);
      background: rgba(21, 25, 37, 0.9);
      box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2), 0 4px 12px rgba(236, 72, 153, 0.15);
      transform: translateY(-1px);
    }
    
    .search-bar input::placeholder {
      color: var(--text-muted);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 20px;
      pointer-events: none;
      display: none;
    }
    
    .search-results {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .search-results.active {
      display: block;
    }
    
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: rgba(236, 72, 153, 0.1);
    }
    
    .search-result-img {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .search-result-info {
      flex: 1;
      min-width: 0;
    }
    
    .search-result-play {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(236, 72, 153, 0.2);
      color: var(--accent-primary);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
    }
    
    .search-result-play:hover {
      background: rgba(236, 72, 153, 0.4);
      transform: scale(1.1);
    }
    
    .search-result-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    
    .search-result-artist {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .search-no-results {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .navbar-center {
      font-size: 1.6rem;
      font-weight: 900;
      background: linear-gradient(135deg, #ec4899 0%, #f97316 50%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
      letter-spacing: -0.8px;
      text-shadow: 0 0 40px rgba(236, 72, 153, 0.3);
      filter: drop-shadow(0 2px 8px rgba(236, 72, 153, 0.2));
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      height: 100vh;
      width: 300px;
      max-width: 85vw;
      background: var(--bg-secondary);
      box-shadow: 4px 0 40px rgba(0,0,0,0.5);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 200;
      overflow-y: auto;
      border-right: 1px solid rgba(255,255,255,0.05);
    }
    
    .sidebar.open {
      left: 0;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-title {
      font-size: 1.5rem;
      font-weight: 800;
      background: var(--gradient-hero);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .close-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: var(--radius-md);
      transition: var(--transition);
    }
    
    .close-btn:hover {
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
      transform: rotate(90deg);
    }
    
    .close-btn:active {
      transform: rotate(90deg) scale(0.9);
    }
    
    .sidebar a, .sidebar button {
      text-decoration: none;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      border: none;
      background: transparent;
      text-align: left;
      padding: 14px 18px;
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .sidebar a:hover, .sidebar button:hover {
      background: rgba(236, 72, 153, 0.1);
      color: var(--accent-primary);
      transform: translateX(4px);
    }
    
    .sidebar a:active, .sidebar button:active {
      transform: translateX(2px) scale(0.98);
    }
    
    .theme-toggle {
      margin-top: auto;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .theme-toggle button {
      background: var(--gradient-hero);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius-xl);
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--shadow-md);
    }
    
    .theme-toggle button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* OVERLAY */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 150;
      backdrop-filter: blur(4px);
    }
    
    .overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* HERO */
    .hero {
      background: linear-gradient(135deg, #667eea 0%, #ec4899 40%, #f97316 80%, #8b5cf6 100%);
      padding: 80px 32px;
      color: white;
      border-radius: 0 0 32px 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      margin-bottom: 40px;
    }
    
    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.15) 0%, transparent 60%);
      pointer-events: none;
    }
    
    .hero::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }
    
    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 800px;
    }
    
    .hero .badge {
      background: rgba(255,255,255,0.25);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      border-radius: var(--radius-xl);
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .hero h1 {
      font-size: clamp(2.5rem, 7vw, 4rem);
      font-weight: 900;
      margin: 0 0 20px 0;
      line-height: 1.1;
      letter-spacing: -1.5px;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      filter: drop-shadow(0 2px 10px rgba(255, 255, 255, 0.1));
    }
    
    .hero p {
      max-width: 600px;
      opacity: 0.95;
      font-size: clamp(1rem, 2.5vw, 1.15rem);
      line-height: 1.7;
      margin: 0;
      font-weight: 400;
    }

    .section {
      padding: 40px 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .section h2 {
      font-size: clamp(1.5rem, 3vw, 2rem);
      font-weight: 800;
      margin: 0 0 24px 0;
      letter-spacing: -0.5px;
    }

    /* FACECAM */
    .facecam-section {
      background: linear-gradient(135deg, rgba(21, 25, 37, 0.9) 0%, rgba(30, 36, 53, 0.8) 100%);
      backdrop-filter: blur(20px);
      padding: 32px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      margin-bottom: 40px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .facecam-section h3 {
      margin: 0 0 20px 0;
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .start-facecam {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .play-btn {
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      color: white;
      border: none;
      padding: 18px 36px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      font-family: inherit;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    
    .play-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .play-btn:hover::before {
      left: 100%;
    }
    
    .play-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(236, 72, 153, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .play-btn:active {
      transform: translateY(0);
    }
    
    .small-btn {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid rgba(255,255,255,0.1);
      padding: 14px 28px;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-family: inherit;
    }
    
    .small-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }
    
    .small-btn:active {
      transform: translateY(0);
    }
    
    .video-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: #000;
      display: none;
      box-shadow: var(--shadow-xl);
    }
    
    .video-container.active {
      display: block;
    }
    
    .video-container video {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .emotion-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(20px);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .emotion-icon {
      font-size: 2rem;
    }
    
    .emotion-text {
      flex: 1;
    }
    
    .emotion-confidence {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .canvas-hidden {
      display: none;
    }
    
    .manual-mood-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid rgba(255,255,255,0.08);
    }
    
    .manual-mood-section h4 {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .manual-mood-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: stretch;
    }
    
    .manual-mood-controls select {
      padding: 14px 20px;
      border-radius: var(--radius-md);
      border: 2px solid rgba(255,255,255,0.1);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      min-width: 220px;
      transition: var(--transition);
    }
    
    .manual-mood-controls select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1);
    }

    /* ARTISTS */
    .artist-buttons {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 16px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }
    
    .artist-buttons button {
      border: 2px solid rgba(255,255,255,0.1);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: var(--radius-xl);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: var(--transition);
      white-space: nowrap;
      font-weight: 700;
      font-size: 15px;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    
    .artist-buttons button img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .artist-buttons button:hover {
      transform: translateY(-2px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }
    
    .artist-buttons button.active {
      background: var(--gradient-hero);
      border-color: transparent;
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .artist-buttons button:active {
      transform: translateY(0);
    }

    /* SONG GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .song-card {
      background: linear-gradient(135deg, rgba(21, 25, 37, 0.9) 0%, rgba(30, 36, 53, 0.8) 100%);
      border-radius: 20px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
      backdrop-filter: blur(10px);
    }
    
    .song-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(236, 72, 153, 0.4), 0 0 0 1px rgba(236, 72, 153, 0.2);
      border-color: rgba(236, 72, 153, 0.5);
      background: linear-gradient(135deg, rgba(21, 25, 37, 0.95) 0%, rgba(30, 36, 53, 0.9) 100%);
    }
    
    .song-card-image {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--gradient-1);
    }
    
    .song-card-image img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s ease;
    }
    
    .song-card:hover .song-card-image img {
      transform: scale(1.08);
    }
    
    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .song-card:hover .play-overlay {
      opacity: 1;
    }
    
    .play-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: var(--shadow-lg);
      color: var(--accent-primary);
      transition: var(--transition);
    }
    
    .play-button:hover {
      transform: scale(1.1);
    }
    
    .song-card .title {
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.3px;
    }
    
    .song-card .artist {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }
    
    .song-card-footer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    
    .song-play-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-hero);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    
    .song-play-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }
    
    .song-play-btn:active {
      transform: scale(0.95);
    }
    
    .song-favorite-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      border: 2px solid rgba(255,255,255,0.2);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 18px;
      flex-shrink: 0;
      margin-left: auto;
    }
    
    .song-favorite-btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: scale(1.1);
    }
    
    .song-favorite-btn.favorited {
      background: rgba(236, 72, 153, 0.15);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }
    
    .song-favorite-btn:active {
      transform: scale(0.9);
    }

    /* MUSIC PLAYER BAR */
    .music-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      padding: 20px 24px;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
      z-index: 90;
      display: none;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .music-player.active {
      display: block;
    }
    
    .player-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .player-song-info {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }
    
    .player-thumbnail {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-md);
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }
    
    .player-details {
      flex: 1;
      min-width: 0;
    }
    
    .player-title {
      font-weight: 700;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    
    .player-artist {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }
    
    .player-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .player-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 20px;
    }
    
    .player-btn:hover {
      background: rgba(255,255,255,0.08);
      transform: scale(1.05);
    }
    
    .player-btn.play-pause {
      width: 52px;
      height: 52px;
      background: var(--gradient-hero);
      color: white;
      font-size: 24px;
      box-shadow: var(--shadow-md);
    }
    
    .player-btn.play-pause:hover {
      transform: scale(1.08);
      box-shadow: var(--shadow-lg);
    }
    
    .player-btn:active {
      transform: scale(0.95);
    }
    
    .volume-control {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 140px;
    }
    
    .volume-icon {
      font-size: 22px;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .volume-icon:hover {
      color: var(--accent-primary);
      transform: scale(1.1);
    }
    
    .volume-slider {
      flex: 1;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .volume-slider-fill {
      height: 100%;
      background: var(--gradient-hero);
      border-radius: 2px;
      width: 70%;
      position: relative;
      transition: width 0.1s ease;
    }
    
    .volume-slider-thumb {
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      position: absolute;
      right: -7px;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: var(--shadow-md);
    }
    
    /* FULLSCREEN PLAYER */
    .fullscreen-player {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-hero);
      z-index: 300;
      display: none;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .fullscreen-player.active {
      display: flex;
    }
    
    .fullscreen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      color: white;
    }
    
    .fullscreen-back {
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .fullscreen-back:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.05);
    }
    
    .fullscreen-back:active {
      transform: scale(0.95);
    }
    
    .fullscreen-title-area {
      text-align: center;
      flex: 1;
    }
    
    .fullscreen-subtitle {
      font-size: 11px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .fullscreen-artist-name {
      font-size: 17px;
      font-weight: 800;
      letter-spacing: -0.3px;
    }
    
    .fullscreen-menu {
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .fullscreen-menu:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.05);
    }
    
    .fullscreen-menu:active {
      transform: scale(0.95);
    }
    
    .fullscreen-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px;
      color: white;
    }
    
    .fullscreen-album-art {
      width: 100%;
      max-width: 420px;
      aspect-ratio: 1;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      margin: 40px 0;
    }
    
    .fullscreen-album-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .fullscreen-song-info {
      width: 100%;
      max-width: 420px;
      text-align: center;
      margin-bottom: 32px;
    }
    
    .fullscreen-song-title {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 10px;
      letter-spacing: -1px;
    }
    
    .fullscreen-song-artist {
      font-size: 1.2rem;
      opacity: 0.95;
      font-weight: 600;
    }
    
    .fullscreen-favorite {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 26px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 24px auto;
    }
    
    .fullscreen-favorite:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }
    
    .fullscreen-favorite.favorited {
      background: rgba(255,255,255,0.35);
    }
    
    .fullscreen-favorite:active {
      transform: scale(0.95);
    }
    
    .fullscreen-progress {
      width: 100%;
      max-width: 420px;
      margin-bottom: 32px;
    }
    
    .progress-bar {
      width: 100%;
      height: 5px;
      background: rgba(255,255,255,0.25);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
      margin-bottom: 12px;
    }
    
    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 3px;
      width: 20%;
      position: relative;
      transition: width 0.1s ease;
    }
    
    .progress-thumb {
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    
    .progress-time {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      opacity: 0.9;
      font-weight: 600;
    }
    
    .fullscreen-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 36px;
    }
    
    .fullscreen-control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: white;
      font-size: 30px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .fullscreen-control-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.05);
    }
    
    .fullscreen-control-btn.play-pause {
      width: 88px;
      height: 88px;
      background: white;
      color: var(--accent-primary);
      font-size: 40px;
      box-shadow: var(--shadow-xl);
    }
    
    .fullscreen-control-btn.play-pause:hover {
      transform: scale(1.08);
    }
    
    .fullscreen-control-btn:active {
      transform: scale(0.95);
    }
    
    .fullscreen-bottom-controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      max-width: 420px;
      padding: 24px 0;
    }
    
    .face-detection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 5;
}

.face-box {
  position: absolute;
  border: 3px solid #00ff00;
  border-radius: 8px;
  box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
}
    .bottom-control-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: white;
      font-size: 26px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .bottom-control-btn:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.05);
    }
    
    .bottom-control-btn:active {
      transform: scale(0.95);
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      opacity: 0.4;
    }
    
    .empty-state h3 {
      font-size: 1.4rem;
      margin: 0 0 12px 0;
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .empty-state p {
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }
    
    /* NOTIFICATION */
    .notification {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 18px 28px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      z-index: 1000;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 90%;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      border: 1px solid rgba(236, 72, 153, 0.3);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .navbar {
        padding: 12px 16px;
      }
      
      .navbar-center {
        font-size: 1.2rem;
      }
      
      .search-bar {
        max-width: none;
      }
      
      .hero {
        padding: 48px 20px;
      }
      
      .section {
        padding: 32px 16px 120px 16px;
      }
      
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 14px;
      }
      
      .song-card {
        padding: 12px;
      }
      
      .volume-control {
        display: none;
      }
      
      .player-controls {
        gap: 12px;
      }
      
      .player-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .player-btn.play-pause {
        width: 48px;
        height: 48px;
        font-size: 22px;
      }
      
      .fullscreen-album-art {
        margin: 24px 0 32px 0;
        max-width: 320px;
      }
      
      .fullscreen-song-title {
        font-size: 1.6rem;
      }
      
      .fullscreen-song-artist {
        font-size: 1rem;
      }
      
      .fullscreen-control-btn.play-pause {
        width: 76px;
        height: 76px;
        font-size: 36px;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }
    .face-detection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 5;
}

.face-box {
  position: absolute;
  border: 3px solid #00ff00;
  border-radius: 8px;
  box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
  animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
  0%, 100% {
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
  }
  50% {
    box-shadow: 0 0 40px rgba(0, 255, 0, 0.8);
  }
}

.face-scanning {
  position: absolute;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ff00, transparent);
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% {
    top: 0;
  }
  100% {
    top: 100%;
  }
}

.detection-status {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.8);
  color: #00ff00;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  font-family: 'Courier New', monospace;
  border: 1px solid #00ff00;
  box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
}

    /* MODAL STYLES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, rgba(21, 25, 37, 0.95) 0%, rgba(30, 36, 53, 0.9) 100%);
      backdrop-filter: blur(30px);
      border-radius: 24px;
      padding: 32px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255,255,255,0.1);
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      font-size: 1.6rem;
      font-weight: 800;
      background: linear-gradient(135deg, #7c3aed 0%, #ec4899 45%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: 2px solid rgba(255,255,255,0.1);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1.5rem;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--accent-primary);
      color: var(--text-primary);
      transform: rotate(90deg) scale(1.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(30, 36, 53, 0.8);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2), 0 4px 12px rgba(236, 72, 153, 0.15);
      transform: translateY(-1px);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }

    .btn {
      flex: 1;
      padding: 14px 28px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed 0%, #ec4899 45%, #f97316 100%);
      color: white;
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(236, 72, 153, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(30, 36, 53, 0.8);
      color: var(--text-primary);
      border: 2px solid rgba(255,255,255,0.1);
    }

    .btn-secondary:hover {
      background: rgba(30, 36, 53, 1);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .playlist-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(30, 36, 53, 0.5);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .playlist-item:hover {
      background: rgba(30, 36, 53, 0.8);
      border-color: var(--accent-primary);
      transform: translateX(4px);
    }

    .playlist-item-info {
      flex: 1;
    }

    .playlist-item-name {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .playlist-item-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* PAGE SECTIONS */
    .page-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* Admin section specific styles */
#adminContent .container {
  max-width: none;
  padding: 0;
}

#adminContent body {
  background: none;
  padding: 0;
}

/* Ensure admin modals work in SPA */
#adminContent .modal {
  position: fixed;
  z-index: 3000;
}

/* Make sure charts render correctly */
#adminContent canvas {
  max-width: 100%;
  height: auto !important;
}

/* Admin notification positioning */
#adminContent .notification {
  position: fixed;
  bottom: 100px; /* Above music player */
  right: 20px;
  z-index: 2500;
}
    /* Language Modal Styles */
.language-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2500;
  padding: 20px;
  overflow-y: auto;
}

.language-modal-overlay.active {
  display: flex;
}

.language-modal {
  background: linear-gradient(135deg, rgba(21, 25, 37, 0.98) 0%, rgba(30, 36, 53, 0.95) 100%);
  backdrop-filter: blur(30px);
  border-radius: 24px;
  padding: 0;
  max-width: 1200px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255,255,255,0.1);
  animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.language-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 28px 32px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  position: sticky;
  top: 0;
  background: linear-gradient(135deg, rgba(21, 25, 37, 0.98) 0%, rgba(30, 36, 53, 0.95) 100%);
  backdrop-filter: blur(30px);
  z-index: 10;
}

.language-modal-title {
  font-size: 1.8rem;
  font-weight: 800;
  background: linear-gradient(135deg, #667eea 0%, #ec4899 50%, #f97316 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.language-modal-close {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: transparent;
  border: 2px solid rgba(255,255,255,0.1);
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 1.5rem;
}

.language-modal-close:hover {
  background: rgba(255,255,255,0.1);
  border-color: var(--accent-primary);
  color: var(--text-primary);
  transform: rotate(90deg) scale(1.1);
}

.language-modal-body {
  padding: 32px;
}

.language-category {
  margin-bottom: 48px;
}

.language-category-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid rgba(236, 72, 153, 0.2);
}

.language-flag {
  font-size: 2.5rem;
}

.language-category-title {
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--text-primary);
}

.language-category-count {
  font-size: 1rem;
  color: var(--text-secondary);
  background: rgba(236, 72, 153, 0.15);
  padding: 6px 14px;
  border-radius: 20px;
  font-weight: 600;
  margin-left: auto;
}

.language-songs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
}

@media (max-width: 768px) {
  .navbar-right {
    display: none !important;
  }
  
  .language-modal {
    max-width: 100%;
    border-radius: 16px;
  }
  
  .language-songs-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 14px;
  }
}
/* Rotating Earth Animation */
@keyframes rotateEarth {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.rotating-earth {
  display: inline-block;
  animation: rotateEarth 10s linear infinite;
}

/* Waving Flag Animation */
@keyframes waveFlag {
  0%, 100% {
    transform: rotate(0deg) scale(1);
  }
  25% {
    transform: rotate(-3deg) scale(1.05);
  }
  50% {
    transform: rotate(3deg) scale(1);
  }
  75% {
    transform: rotate(-2deg) scale(1.05);
  }
}

.waving-flag {
  display: inline-block;
  animation: waveFlag 2.5s ease-in-out infinite;
  transform-origin: bottom left;
}













/* Additional styles for new modals */
.small-btn {
  display: flex;
  align-items: center;
  gap: 8px;
}

.playlist-item {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.playlist-item:hover {
  background: rgba(236, 72, 153, 0.05) !important;
}

/* Additional styles for scrollable modals with custom scrollbar */
.modal > div[style*="overflow-y: auto"] {
  scrollbar-width: thin;
  scrollbar-color: var(--accent-primary) rgba(255,255,255,0.1);
}

.modal > div[style*="overflow-y: auto"]::-webkit-scrollbar {
  width: 8px;
}

.modal > div[style*="overflow-y: auto"]::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

.modal > div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
  background: var(--accent-primary);
  border-radius: 4px;
}

.modal > div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb:hover {
  background: var(--accent-secondary);
}

.small-btn {
  display: flex;
  align-items: center;
  gap: 8px;
}

.playlist-item {
  display: flex;
  align-items: center;
  cursor: pointer;
}

.playlist-item:hover {
  background: rgba(236, 72, 153, 0.05) !important;
}

/* Smooth scrolling for all modals */
.modal-overlay {
  overflow-y: auto;
}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="navbar-left">
      <div class="menu-icon" onclick="toggleSidebar()" role="button" aria-label="Open menu">â˜°</div>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search songs or artists..." oninput="handleSearch()" onfocus="handleSearchFocus()" aria-label="Search" />
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>
    <div class="navbar-center" id="navbarTitle">ðŸŽ§ VibeSync</div>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar" role="navigation">
    <div class="sidebar-header">
      <div class="sidebar-title">Menu</div>
      <div class="close-btn" onclick="toggleSidebar()" role="button" aria-label="Close menu">âœ–</div>
    </div>
    <a href="#" onclick="showSection('home')">ðŸ  Home</a>
    <a href="#" onclick="showSection('recently')">ðŸ• Recently Played</a>
    <a href="#" onclick="showSection('favorites')">â¤ï¸ Favorites</a>
    <a href="#" onclick="showSection('playlist')">ðŸ“‹ Playlists</a>
    <button onclick="openCreatePlaylistModal()" style="background: transparent; border: none; color: var(--text-primary); font-size: 16px; font-weight: 600; text-align: left; padding: 14px 18px; cursor: pointer; transition: var(--transition); border-radius: var(--radius-md); display: flex; align-items: center; gap: 14px; width: 100%; font-family: inherit;">âž• Create Playlist</button>
    <a href="#" onclick="showSection('languages')">ðŸŒ Languages</a> <!-- NEW -->
    </button>
  </div>
    <a href="#" onclick="showSection('profile')">ðŸ‘¤ Profile</a>
    
    <a href="#" id="adminBtn" style="display: none;" onclick="showSection('admin')">âš™ï¸ Admin Panel</a>
    <button onclick="handleLogout()">ðŸšª Logout</button>
    <div class="theme-toggle">
      <span style="font-weight: 600;">Theme</span>
      <button onclick="toggleTheme()" id="themeBtn">ðŸŒ™ Dark</button>
    </div>
  </nav>
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- PAGE SECTIONS CONTAINER -->
  <div id="pageSections">
    <!-- HOME SECTION -->
    <div id="homeSection" class="page-section active">
      <!-- HERO -->
      <section class="hero">
        <div class="hero-content">
          <div class="badge">âœ¨ AI-Powered</div>
          <h1>Music that matches your mood</h1>
          <p>Experience intelligent emotion detection that curates the perfect soundtrack for every moment. Let AI understand your feelings and discover music you'll love.</p>
        </div>
      </section>

      <!-- MAIN CONTENT -->
      <div class="section">
    <!-- FACECAM SECTION -->
    <div class="facecam-section">
      <h3>ðŸŽ¥ Emotion Detection</h3>
      <div class="start-facecam">
        <button class="play-btn" onclick="startFacecam()">Start Facecam</button>
        <button class="small-btn" onclick="stopFacecam()">Stop</button>
      </div>
      <div style="margin-top:16px;color:var(--text-secondary);font-size:14px;line-height:1.6;">
        <strong>Tip:</strong> Allow camera permission. Your emotion will be analyzed in real-time and recommendations will update automatically based on your mood.
      </div>
      
      <!-- Video Preview Container -->
      <div class="video-container" id="videoContainer">
  <video id="videoElement" autoplay playsinline></video>
  <canvas id="canvas" class="canvas-hidden"></canvas>
  
  <!-- NEW: Landmark overlay canvas -->
  <canvas id="landmarkCanvas" style="
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
  "></canvas>
  
  <div class="emotion-overlay" id="emotionOverlay">
    <span class="emotion-icon">ðŸ˜Š</span>
    <div class="emotion-text">
      <div id="emotionLabel">Detecting emotion...</div>
      <div class="emotion-confidence" id="emotionConfidence">Analyzing...</div>
    </div>
  </div>
</div>
      
      <!-- Manual Mood Selector -->
      <div class="manual-mood-section">
        <h4>ðŸ˜Š Or select your mood manually:</h4>
        <div class="manual-mood-controls">
          <select id="manualMood">
            <option value="">-- Choose Your Mood --</option>
            <option value="Happy">ðŸ˜Š Happy</option>
            <option value="Sad">ðŸ˜¢ Sad</option>
            <option value="Angry">ðŸ˜  Angry</option>
            <option value="Surprise">ðŸ˜² Surprise</option>
            <option value="Fear">ðŸ˜¨ Fear</option>
            <option value="Disgust">ðŸ¤¢ Disgust</option>
            <option value="Neutral">ðŸ˜ Neutral</option>
          </select>
          <button class="small-btn" onclick="applyManualMood()">Apply Mood</button>
        </div>
      </div>
    </div>

    <h2>Featured Artists</h2>
    <div class="artist-buttons" id="artistList"></div>
  </div>


  <!-- SONGS -->
  <div class="section">
    <h2>Trending Now</h2>
    <div class="grid" id="songGrid">    </div>
      </div>
    </div>
  </div>
  
  <!-- RECENTLY PLAYED SECTION -->
  <div id="recentlySection" class="page-section">
    <div id="recentlyContent" style="min-height: 100vh;"></div>
  </div>

  <!-- FAVORITES SECTION -->
  <div id="favoritesSection" class="page-section">
    <div id="favoritesContent" style="min-height: 100vh;"></div>
  </div>

  <!-- PLAYLIST SECTION -->
  <div id="playlistSection" class="page-section">
    <div id="playlistContent" style="min-height: 100vh;"></div>
  </div>

  <!-- PROFILE SECTION -->
  <div id="profileSection" class="page-section">
    <div id="profileContent" style="min-height: 100vh;"></div>
  </div>

  <!-- LANGUAGES SECTION -->
<div id="languagesSection" class="page-section">
  <div id="languagesContent" style="min-height: 100vh;"></div>
</div>


  <!-- ADMIN SECTION -->
  <div id="adminSection" class="page-section">
    <div id="adminContent" style="min-height: 100vh;"></div>
  </div>
  </div>
  <!-- End PAGE SECTIONS -->

  <!-- MUSIC PLAYER BAR -->
  <div class="music-player" id="musicPlayer">
    <div class="player-content" onclick="openFullscreenPlayer()">
      <div class="player-song-info">
        <img id="playerThumbnail" class="player-thumbnail" src="" alt="Song thumbnail" />
        <div class="player-details">
          <div class="player-title" id="playerTitle">No song playing</div>
          <div class="player-artist" id="playerArtist">Select a song to play</div>
        </div>
      </div>
      
      <div class="player-controls" onclick="event.stopPropagation()">
        <button class="player-btn" onclick="previousSong()" title="Previous">â®</button>
        <button class="player-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn" title="Play/Pause">â–¶</button>
        <button class="player-btn" onclick="nextSong()" title="Next">â­</button>
      </div>
      
      <div class="volume-control" onclick="event.stopPropagation()">
        <span class="volume-icon" onclick="toggleMute()" id="volumeIcon">ðŸ”Š</span>
        <div class="volume-slider" onclick="setVolume(event)">
          <div class="volume-slider-fill" id="volumeFill">
            <div class="volume-slider-thumb"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN PLAYER -->
  <div class="fullscreen-player" id="fullscreenPlayer">
    <div class="fullscreen-header">
      <div class="fullscreen-back" onclick="closeFullscreenPlayer()">â–¼</div>
      <div class="fullscreen-title-area">
        <div class="fullscreen-subtitle">PLAYING FROM ARTIST</div>
        <div class="fullscreen-artist-name" id="fullscreenArtistName">Lana Rivers</div>
      </div>
      <div class="fullscreen-menu">â‹®</div>
    </div>
    
    <div class="fullscreen-content">
      <div class="fullscreen-album-art">
        <img id="fullscreenAlbumArt" src="https://picsum.photos/400/400?random=1" alt="Album Art" />
      </div>
      
      <div class="fullscreen-song-info">
        <div class="fullscreen-song-title" id="fullscreenSongTitle">Sunshine Drive</div>
        <div class="fullscreen-song-artist" id="fullscreenSongArtist">Lana Rivers</div>
      </div>
      
      <button class="fullscreen-favorite" id="fullscreenFavorite" onclick="toggleCurrentFavorite()">
        ðŸ¤
      </button>
      
      <div class="fullscreen-progress">
        <div class="progress-bar" onclick="setProgress(event)">
          <div class="progress-fill" id="progressFill">
            <div class="progress-thumb"></div>
          </div>
        </div>
        <div class="progress-time">
          <span id="currentTime">0:00</span>
          <span id="totalTime">6:04</span>
        </div>
      </div>
      
      <div class="fullscreen-controls">
        <button class="fullscreen-control-btn" onclick="previousSong()" title="Previous">â®</button>
        <button class="fullscreen-control-btn play-pause" onclick="togglePlayPause()" id="fullscreenPlayPause" title="Play/Pause">â¸</button>
        <button class="fullscreen-control-btn" onclick="nextSong()" title="Next">â­</button>
      </div>
      
      <div class="fullscreen-bottom-controls">
        <button class="bottom-control-btn" title="Connect">ðŸ“±</button>
        <button class="bottom-control-btn" onclick="toggleTimer()" title="Timer">â±</button>
        <button class="bottom-control-btn" onclick="shareCurrentSong()" title="Share">ðŸ”—</button>
        <button class="bottom-control-btn" onclick="openQueue()" title="Queue">â˜°</button>
      </div>
    </div>
  </div>

  <!-- CREATE PLAYLIST MODAL -->
  <div class="modal-overlay" id="createPlaylistModal" onclick="if(event.target.id === 'createPlaylistModal') closeCreatePlaylistModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Create New Playlist</h3>
        <button class="modal-close" onclick="closeCreatePlaylistModal()">âœ–</button>
      </div>
      
      <form id="createPlaylistForm" onsubmit="saveNewPlaylist(event)">
        <div class="form-group">
          <label class="form-label" for="newPlaylistName">Playlist Name *</label>
          <input 
            type="text" 
            id="newPlaylistName" 
            class="form-input" 
            placeholder="My Awesome Playlist" 
            required 
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="newPlaylistDescription">Description</label>
          <textarea 
            id="newPlaylistDescription" 
            class="form-input form-textarea" 
            placeholder="Describe your playlist..."
            style="min-height: 100px; resize: vertical;"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCreatePlaylistModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Playlist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD TO PLAYLIST MODAL -->
  <div class="modal-overlay" id="addToPlaylistModal" onclick="if(event.target.id === 'addToPlaylistModal') closeAddToPlaylistModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Add to Playlist</h3>
        <button class="modal-close" onclick="closeAddToPlaylistModal()">âœ–</button>
      </div>
      
      <div id="playlistsList" style="max-height: 400px; overflow-y: auto;">
        <div class="loading">Loading playlists...</div>
      </div>
      
      <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeAddToPlaylistModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="openCreatePlaylistModal(); closeAddToPlaylistModal();">âž• Create New Playlist</button>
      </div>
    </div>
  </div>


  <script>
   // Authentication check
fetch('/api/auth/me')
  .then(res => {
      if (!res.ok) {
          window.location.href = '/login';
          throw new Error('Not authenticated');
      }
      return res.json();
  })
  .then(user => {
      console.log('âœ… User authenticated:', user.email, 'ID:', user.id);
      
      // âœ… CRITICAL: Set user FIRST before anything else
      window.currentUser = user;
      
      if (user.isAdmin) {
          isAdmin = true;
          updateAdminVisibility();
          console.log('âœ“ Admin mode enabled');
      }
      
      // Now load songs (which will then load favorites state)
      loadSongsFromDatabase();
  })
  .catch((error) => {
      console.error('Authentication error:', error);
      window.location.href = '/login';
  });
// Data
const artists = [
  { name: "All Artists", cover: "https://i.pravatar.cc/80?img=0" }
];

let songs = []; // Will be loaded from database
let allSongs = []; // Keep all songs for filtering

// Variables
const artistListEl = document.getElementById("artistList");
const songGridEl = document.getElementById("songGrid");
const searchInput = document.getElementById("searchInput");
let currentArtist = null;
let isDarkMode = true;
let isAdmin = false;
let currentSongIndex = -1;
let isPlaying = false;
let volume = 70;
let isMuted = false;
let currentProgress = 0;
let facecamActive = false;
let videoStream = null;
let detectionInterval = null;
let currentLanguage = null;  // NEW LINE

// Use shared audio player
let audioPlayer = window.sharedAudioPlayer.audio || new Audio();
audioPlayer.volume = 0.7;

// Sync with shared player
if (window.sharedAudioPlayer.audio) {
  audioPlayer = window.sharedAudioPlayer.audio;
} else {
  window.sharedAudioPlayer.audio = audioPlayer;
}

// Audio event listeners
audioPlayer.addEventListener('timeupdate', () => {
  if (audioPlayer.duration) {
    currentProgress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    updateProgressUI();
    window.sharedAudioPlayer.currentTime = audioPlayer.currentTime;
  }
});

audioPlayer.addEventListener('ended', () => {
  nextSong();
});

audioPlayer.addEventListener('loadedmetadata', () => {
  const totalMin = Math.floor(audioPlayer.duration / 60);
  const totalSec = Math.floor(audioPlayer.duration % 60);
  const totalTimeEl = document.getElementById('totalTime');
  if (totalTimeEl) {
    totalTimeEl.textContent = `${totalMin}:${totalSec.toString().padStart(2, '0')}`;
  }
});

const emotionIcons = {
  'Angry': 'ðŸ˜ ',
  'Disgust': 'ðŸ¤¢',
  'Fear': 'ðŸ˜¨',
  'Happy': 'ðŸ˜Š',
  'Sad': 'ðŸ˜¢',
  'Surprise': 'ðŸ˜²',
  'Neutral': 'ðŸ˜'
};

// ========================================
// LOAD SONGS FROM DATABASE (NEW FUNCTION)
// ========================================
async function loadSongsFromDatabase() {
  try {
    showNotification('Loading songs...');
    
    const response = await fetch('/api/songs');
    if (!response.ok) {
      throw new Error('Failed to load songs');
    }
    
    const songsData = await response.json();
    
    // Transform MongoDB songs to match our format
    allSongs = songsData.map(song => ({
      id: song._id,
      title: song.title,
      artist: song.artist,
      img: song.coverUrl || 'https://picsum.photos/400/400?random=' + Math.random(),
      audioUrl: song.audioUrl || '',
      artistPhotoUrl: song.artistPhotoUrl || '',
      emotions: song.emotions || [],
      language: song.language || 'English',  // NEW LINE
      favorited: false
    }));
    
    songs = [...allSongs];
    
    console.log(`âœ“ Loaded ${songs.length} songs from database`);
    
    // Extract unique artists
    const uniqueArtists = [...new Set(songs.map(s => s.artist))];
    artists.length = 1; // Keep "All Artists"
    uniqueArtists.forEach(artistName => {
      const song = songs.find(s => s.artist === artistName);
      artists.push({
        name: artistName,
        cover: song.artistPhotoUrl || `https://i.pravatar.cc/80?img=${Math.floor(Math.random() * 70)}`
      });
    });
    
    // âœ… Load favorites state BEFORE rendering
    loadFavoritesState();
    
    // Render everything
    renderArtists();
    renderSongs();
    loadLanguages();
    // Load playback state AFTER songs are loaded
    loadPlaybackState();
    
    if (songs.length === 0) {
      songGridEl.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
          <div class="empty-state-icon">ðŸŽµ</div>
          <h3>No songs available</h3>
          <p>Admin hasn't added any songs yet</p>
        </div>
      `;
    }
    
  } catch (error) {
    console.error('Error loading songs:', error);
    showNotification('âŒ Failed to load songs');
    
    songGridEl.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="empty-state-icon">âš ï¸</div>
        <h3>Failed to load songs</h3>
        <p>Please refresh the page or contact support</p>
      </div>
    `;
  }
}
// Render functions
function renderArtists() {
  artistListEl.innerHTML = "";
  const allBtn = document.createElement("button");
  allBtn.textContent = "All";
  allBtn.className = !currentArtist ? "active" : "";
  allBtn.onclick = () => { 
    currentArtist = null; 
    songs = [...allSongs];
    renderArtists(); 
    renderSongs(); 
  };
  artistListEl.appendChild(allBtn);
  
  // Get unique artists from loaded songs
  const uniqueArtists = [...new Set(allSongs.map(s => s.artist))];
  
  uniqueArtists.forEach(artistName => {
    const song = allSongs.find(s => s.artist === artistName);
    const btn = document.createElement("button");
    
    if (song && song.artistPhotoUrl) {
      const img = document.createElement("img");
      img.src = song.artistPhotoUrl;
      img.alt = artistName;
      btn.appendChild(img);
    }
    
    btn.appendChild(document.createTextNode(artistName));
    if (currentArtist === artistName) btn.classList.add("active");
    btn.onclick = () => { 
      currentArtist = artistName; 
      songs = allSongs.filter(s => s.artist === artistName);
      renderArtists(); 
      renderSongs(); 
    };
    artistListEl.appendChild(btn);
  });
}

// Load and render languages
async function loadLanguages() {
  try {
    const response = await fetch('/api/songs/languages');
    const languages = await response.json();
    
    const languageList = document.getElementById('languageList');
    if (!languageList) return;
    
    // Always have "All Languages" button
    let html = '<button class="active" onclick="filterByLanguage(null)">All Languages</button>';
    
    // Add language buttons
    languages.forEach(lang => {
      html += `<button onclick="filterByLanguage('${lang}')">${lang}</button>`;
    });
    
    languageList.innerHTML = html;
  } catch (e) {
    console.error('Error loading languages:', e);
  }
}

// Filter songs by language
function filterByLanguage(language) {
  currentLanguage = language;
  
  // Update active button
  const buttons = document.querySelectorAll('#languageList button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Filter songs
  if (language) {
    songs = allSongs.filter(s => s.language === language);
  } else {
    songs = [...allSongs];
  }
  
  // Reset artist filter
  currentArtist = null;
  
  renderArtists();
  renderSongs();
  
  showNotification(`ðŸŒ Showing ${language || 'all'} songs`);
}


// âœ… Load favorites from localStorage and mark songs as favorited
async function loadFavoritesState() {
  if (!window.currentUser || !window.currentUser.id) {
    return;
  }
  
  try {
    const response = await fetch('/api/favorites');
    if (!response.ok) {
      throw new Error('Failed to load favorites');
    }
    
    const favorites = await response.json();
    console.log('ðŸ“š Loading favorites from backend:', favorites);
    
    // Mark songs as favorited
    favorites.forEach(fav => {
      const song = songs.find(s => s.id === fav.id);
      if (song) {
        song.favorited = true;
      }
      
      const allSong = allSongs.find(s => s.id === fav.id);
      if (allSong) {
        allSong.favorited = true;
      }
    });
    
    console.log(`âœ… Loaded ${favorites.length} favorites from backend`);
  } catch (e) {
    console.error('Error loading favorites state:', e);
  }
}

function renderSongs() {
  songGridEl.innerHTML = "";
  const query = searchInput.value.trim().toLowerCase();
  let filtered = songs;
  
  if (query) {
    filtered = filtered.filter(s => 
      s.title.toLowerCase().includes(query) || 
      s.artist.toLowerCase().includes(query)
    );
  }
  
  if (filtered.length === 0) {
    songGridEl.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="empty-state-icon">ðŸŽµ</div>
        <h3>No songs found</h3>
        <p>Try adjusting your search or filters</p>
      </div>
    `;
    return;
  }
  
  filtered.forEach(s => {
    const card = document.createElement("div");
    card.className = "song-card";
    card.innerHTML = `
      <div class="song-card-image" onclick="playSongById('${s.id}')">
        <img src="${s.img}" alt="${s.title}" loading="lazy" />
        <div class="play-overlay">
          <div class="play-button">â–¶</div>
        </div>
      </div>
      <div class="title">${s.title}</div>
      <div class="artist">${s.artist}</div>
      <div class="song-card-footer">
        <button class="song-play-btn" onclick="playSongById('${s.id}')" title="Play">â–¶</button>
        <button class="song-favorite-btn ${s.favorited ? 'favorited' : ''}" onclick="toggleFavorite(event, '${s.id}')" title="Favorite">
          ${s.favorited ? 'â¤ï¸' : 'ðŸ¤'}
        </button>
        <button class="song-favorite-btn" onclick="openAddToPlaylistModal('${s.id}')" title="Add to Playlist" style="margin-left: 4px;">
          ðŸ“‹
        </button>
      </div>
    `;
    songGridEl.appendChild(card);
  });
}

// Player functions
function playSongById(songId) {
  const songIndex = songs.findIndex(s => s.id === songId);
  if (songIndex === -1) return;
  
  currentSongIndex = songIndex;
  const song = songs[songIndex];
  
  // Use shared player
  window.sharedAudioPlayer.playSong(song, songs);
  
  // Update local state
  isPlaying = true;
  
  // Update UI
  document.getElementById('playerThumbnail').src = song.img;
  document.getElementById('playerTitle').textContent = song.title;
  document.getElementById('playerArtist').textContent = song.artist;
  document.getElementById('musicPlayer').classList.add('active');
  
  updateFullscreenPlayer(song);
  updatePlayPauseButton();
  showNotification(`â–¶ Now playing: ${song.title}`);
}

// Track recently played
async function trackRecentlyPlayed(song) {
  try {
    await fetch('/api/recently-played', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        songId: song.id,
        title: song.title,
        artist: song.artist
      })
    });
  } catch (error) {
    console.error('Error tracking recently played:', error);
  }
}

function updateFullscreenPlayer(song) {
  if (!song && currentSongIndex === -1) return;
  
  const currentSong = song || songs[currentSongIndex];
  
  document.getElementById('fullscreenAlbumArt').src = currentSong.img;
  document.getElementById('fullscreenSongTitle').textContent = currentSong.title;
  document.getElementById('fullscreenSongArtist').textContent = currentSong.artist;
  document.getElementById('fullscreenArtistName').textContent = currentSong.artist;
  
  const favBtn = document.getElementById('fullscreenFavorite');
  favBtn.textContent = currentSong.favorited ? 'â¤ï¸' : 'ðŸ¤';
  if (currentSong.favorited) {
    favBtn.classList.add('favorited');
  } else {
    favBtn.classList.remove('favorited');
  }
}

function openFullscreenPlayer() {
  if (currentSongIndex === -1) {
    showNotification('Please select a song first');
    return;
  }
  document.getElementById('fullscreenPlayer').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeFullscreenPlayer() {
  document.getElementById('fullscreenPlayer').classList.remove('active');
  document.body.style.overflow = '';
}

async function toggleFavorite(event, songId) {
  event.stopPropagation();
  
  console.log('ðŸŽµ Toggle favorite for song ID:', songId);
  
  const song = songs.find(s => s.id === songId);
  if (!song) {
    console.error('âŒ Song not found:', songId);
    return;
  }
  
  const wasFavorited = song.favorited;
  song.favorited = !song.favorited;
  
  // Also update in allSongs
  const allSong = allSongs.find(s => s.id === songId);
  if (allSong) allSong.favorited = song.favorited;
  
  if (!window.currentUser || !window.currentUser.id) {
    console.error('âŒ No user logged in');
    showNotification('Please login to add favorites');
    song.favorited = wasFavorited;
    if (allSong) allSong.favorited = wasFavorited;
    return;
  }
  
  try {
    if (song.favorited) {
      // Add to favorites via API
      const response = await fetch('/api/favorites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          songId: song.id,
          title: song.title,
          artist: song.artist,
          coverUrl: song.img,
          audioUrl: song.audioUrl || '',
          artistPhotoUrl: song.artistPhotoUrl || ''
        })
      });
      
      if (!response.ok) {
        throw new Error('Failed to add favorite');
      }
      
      showNotification('â¤ï¸ Added to favorites');
    } else {
      // Remove from favorites via API
      const response = await fetch(`/api/favorites/${song.id}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Failed to remove favorite');
      }
      
      showNotification('ðŸ¤ Removed from favorites');
    }
    
    renderSongs();
    if (currentSongIndex !== -1 && songs[currentSongIndex].id === songId) {
      updateFullscreenPlayer(song);
    }
  } catch (error) {
    console.error('Error toggling favorite:', error);
    // Revert on error
    song.favorited = wasFavorited;
    if (allSong) allSong.favorited = wasFavorited;
    showNotification('âŒ Failed to update favorite');
    renderSongs();
  }
}

function togglePlayPause() {
  if (!window.sharedAudioPlayer.currentSong) {
    showNotification('Please select a song first');
    return;
  }
  
  window.sharedAudioPlayer.togglePlayPause();
  isPlaying = window.sharedAudioPlayer.isPlaying;
  updatePlayPauseButton();
  
  const song = window.sharedAudioPlayer.currentSong;
  showNotification(isPlaying ? `â–¶ Playing: ${song.title}` : `â¸ Paused: ${song.title}`);
}

function updatePlayPauseButton() {
  const btn = document.getElementById('playPauseBtn');
  const fullscreenBtn = document.getElementById('fullscreenPlayPause');
  btn.textContent = isPlaying ? 'â¸' : 'â–¶';
  fullscreenBtn.textContent = isPlaying ? 'â¸' : 'â–¶';
}

function toggleCurrentFavorite() {
  if (currentSongIndex === -1) return;
  
  const song = songs[currentSongIndex];
  song.favorited = !song.favorited;
  
  updateFullscreenPlayer(song);
  renderSongs();
  
  showNotification(song.favorited ? 'â¤ï¸ Added to favorites' : 'ðŸ¤ Removed from favorites');
}

function setProgress(event) {
  const bar = event.currentTarget;
  const rect = bar.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
  
  if (audioPlayer.duration) {
    audioPlayer.currentTime = (percentage / 100) * audioPlayer.duration;
  }
  currentProgress = percentage;
  updateProgressUI();
}

function updateProgressUI() {
  const fill = document.getElementById('progressFill');
  fill.style.width = currentProgress + '%';
  
  if (audioPlayer.duration) {
    const currentSeconds = Math.floor(audioPlayer.currentTime);
    const currentMin = Math.floor(currentSeconds / 60);
    const currentSec = currentSeconds % 60;
    
    document.getElementById('currentTime').textContent = 
      `${currentMin}:${currentSec.toString().padStart(2, '0')}`;
  }
}

function previousSong() {
  window.sharedAudioPlayer.previousSong();
  // Update local index
  if (window.sharedAudioPlayer.currentSong) {
    const newIndex = songs.findIndex(s => s.id === window.sharedAudioPlayer.currentSong.id);
    if (newIndex !== -1) {
      currentSongIndex = newIndex;
      isPlaying = window.sharedAudioPlayer.isPlaying;
      updatePlayPauseButton();
    }
  }
}

function nextSong() {
  window.sharedAudioPlayer.nextSong();
  // Update local index
  if (window.sharedAudioPlayer.currentSong) {
    const newIndex = songs.findIndex(s => s.id === window.sharedAudioPlayer.currentSong.id);
    if (newIndex !== -1) {
      currentSongIndex = newIndex;
      isPlaying = window.sharedAudioPlayer.isPlaying;
      updatePlayPauseButton();
    }
  }
}

function setVolume(event) {
  const slider = event.currentTarget;
  const rect = slider.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
  
  volume = Math.round(percentage);
  audioPlayer.volume = volume / 100;
  updateVolumeUI();
  
  if (volume > 0) {
    isMuted = false;
  }
}

function toggleMute() {
  isMuted = !isMuted;
  audioPlayer.muted = isMuted;
  updateVolumeUI();
}

function updateVolumeUI() {
  const fill = document.getElementById('volumeFill');
  const icon = document.getElementById('volumeIcon');
  
  const displayVolume = isMuted ? 0 : volume;
  fill.style.width = displayVolume + '%';
  
  if (isMuted || volume === 0) {
    icon.textContent = 'ðŸ”‡';
  } else if (volume < 50) {
    icon.textContent = 'ðŸ”‰';
  } else {
    icon.textContent = 'ðŸ”Š';
  }
}

function toggleTimer() {
  showNotification('â± Sleep timer feature coming soon!');
}

function shareCurrentSong() {
  if (currentSongIndex === -1) return;
  const song = songs[currentSongIndex];
  showNotification(`ðŸ”— Sharing: ${song.title} by ${song.artist}`);
}

function openQueue() {
  showNotification('â˜° Queue view coming soon!');
}

    // UI functions
    function handleSearch() {
      const query = searchInput.value.trim().toLowerCase();
      const searchResults = document.getElementById('searchResults');
      
      if (query === '') {
        searchResults.classList.remove('active');
        renderSongs();
        return;
      }
      
      const filtered = songs.filter(s => 
        s.title.toLowerCase().includes(query) || 
        s.artist.toLowerCase().includes(query)
      );
      
      if (filtered.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">No songs found</div>';
        searchResults.classList.add('active');
      } else {
        searchResults.innerHTML = filtered.map(s => `
          <div class="search-result-item" onclick="playSearchResult('${s.id}')">
            <img src="${s.img}" alt="${s.title}" class="search-result-img" />
            <div class="search-result-info">
              <div class="search-result-title">${s.title}</div>
              <div class="search-result-artist">${s.artist}</div>
            </div>
            <div class="search-result-play" onclick="event.stopPropagation(); playSearchResult('${s.id}')" title="Play">
              â–¶
            </div>
          </div>
        `).join('');
        searchResults.classList.add('active');
      }
    }
    
    function handleSearchFocus() {
      const query = searchInput.value.trim();
      if (query !== '') {
        handleSearch();
      }
    }
    
    function playSearchResult(songId) {
      // Ensure songId is a string for MongoDB IDs
      const id = String(songId);
      
      // Find and play the song
      const songIndex = songs.findIndex(s => String(s.id) === id);
      if (songIndex === -1) {
        showNotification('âš ï¸ Song not found');
        return;
      }
      
      // Play the song using the standard playSongById function
      playSongById(id);
      
      // Clear search and close results
      searchInput.value = '';
      document.getElementById('searchResults').classList.remove('active');
      
      // Show notification
      const song = songs[songIndex];
      showNotification(`â–¶ Now playing: ${song.title}`);
    }
    
    function searchMusic() {
      renderSongs();
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(event) {
      const searchBar = document.querySelector('.search-bar');
      const searchResults = document.getElementById('searchResults');
      
      if (searchBar && !searchBar.contains(event.target)) {
        searchResults.classList.remove('active');
      }
    });

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
      document.getElementById("overlay").classList.toggle("show");
      document.body.style.overflow = document.getElementById("sidebar").classList.contains("open") ? 'hidden' : '';
    }

    function toggleTheme() {
      const body = document.body;
      const btn = document.getElementById("themeBtn");
      isDarkMode = !isDarkMode;
      
      if (isDarkMode) {
        body.classList.remove("light");
        btn.textContent = "ðŸŒ™ Dark";
      } else {
        body.classList.add("light");
        btn.textContent = "â˜€ï¸ Light";
      }
    }

    function showSection(section) {
  toggleSidebar();
  
  // Hide all sections
  document.querySelectorAll('.page-section').forEach(sec => {
    sec.classList.remove('active');
  });
  
  // Show selected section
  const sectionId = section + 'Section';
  const targetSection = document.getElementById(sectionId);
  
  // Update navbar title
  const sectionTitles = {
    'home': 'ðŸŽ§ VibeSync',
    'recently': 'ðŸ• Recently Played',
    'favorites': 'â¤ï¸ Favorites',
    'playlist': 'ðŸ“‹ Playlists',
    'languages': 'ðŸŒ Languages',
    'profile': 'ðŸ‘¤ Profile',
    'admin': 'âš™ï¸ Admin Panel'
  };
  const navbarTitle = document.getElementById('navbarTitle');
  if (navbarTitle) {
    navbarTitle.textContent = sectionTitles[section] || 'ðŸŽ§ VibeSync';
  }
  
  if (targetSection) {
    targetSection.classList.add('active');
    
    // ðŸ”§ FIX: Force reload playlist section every time
    const container = targetSection.querySelector('[id$="Content"]');
    if (container) {
      if (section === 'favorites') {
        container.dataset.loaded = 'false'; // Force reload
        loadFavoritesSection();
      } else if (section === 'recently') {
        container.dataset.loaded = 'false'; // Force reload
        loadRecentlySection();
      } else if (section === 'playlist') {
        container.dataset.loaded = 'false'; // ðŸŽ¯ FORCE RELOAD PLAYLISTS
        loadPlaylistSection();
      } else if (section === 'languages') {
        container.dataset.loaded = 'false';  // NEW
        loadLanguagesSection();  // NEW
      } else if (section === 'profile') {
        container.dataset.loaded = 'false'; // Force reload
        loadProfileSection();
      } else if (section === 'admin') {
        if (isAdmin) {
          loadAdminSection();
        } else {
          showNotification('âŒ Admin access denied');
          document.getElementById('homeSection').classList.add('active');
          if (navbarTitle) navbarTitle.textContent = 'ðŸŽ§ VibeSync';
          return;
        }
      }
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } else {
    showNotification(`Section "${section}" not found`);
    document.getElementById('homeSection').classList.add('active');
    if (navbarTitle) navbarTitle.textContent = 'ðŸŽ§ VibeSync';
  }
}
    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          showNotification('Logging out...');
          
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Clear all local storage and session storage
            localStorage.clear();
            sessionStorage.clear();
            
            // Replace current history entry to prevent back button
            window.history.replaceState(null, null, '/login');
            
            showNotification('âœ… Logged out successfully');
            setTimeout(() => {
              // Force redirect and prevent back navigation
              window.location.replace('/login');
            }, 800);
          } else {
            showNotification('âŒ Logout failed');
            setTimeout(() => {
              window.location.replace('/login');
            }, 1000);
          }
          
        } catch (error) {
          console.error('Logout error:', error);
          // Clear storage even on error
          localStorage.clear();
          sessionStorage.clear();
          window.history.replaceState(null, null, '/login');
          showNotification('Logging out...');
          setTimeout(() => {
            window.location.replace('/login');
          }, 800);
        }
      }
    }

    // Check authentication on page load and prevent back navigation after logout
    window.addEventListener('load', async function() {
      try {
        const response = await fetch('/api/auth/me');
        if (!response.ok) {
          // Not authenticated, redirect to login
          window.location.replace('/login');
          return;
        }
      } catch (error) {
        // Error checking auth, redirect to login
        window.location.replace('/login');
      }
    });

    // Prevent back button navigation to protected pages after logout
    window.addEventListener('popstate', function(event) {
      // Check if user is still authenticated
      fetch('/api/auth/me')
        .then(response => {
          if (!response.ok) {
            // Not authenticated, redirect to login
            window.location.replace('/login');
          }
        })
        .catch(() => {
          window.location.replace('/login');
        });
    });

    function updateAdminVisibility() {
      const adminBtn = document.getElementById('adminBtn');
      if (adminBtn) {
        adminBtn.style.display = isAdmin ? 'flex' : 'none';
      }
    }

    // Facecam functions
    async function startFacecam() {
      if (facecamActive) {
        showNotification('Facecam is already running');
        return;
      }

      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          } 
        });
        
        const videoElement = document.getElementById('videoElement');
        const videoContainer = document.getElementById('videoContainer');
        
        videoElement.srcObject = videoStream;
        videoContainer.classList.add('active');
        facecamActive = true;
        
        showNotification('âœ… Facecam started! Analyzing emotions...');
        
        detectionInterval = setInterval(detectEmotion, 3000);
        
      } catch (err) {
        showNotification('âŒ Camera permission denied or unavailable');
        console.error('Camera error:', err);
      }
    }

   async function detectEmotion() {
  if (!facecamActive) return;
  
  try {
    const videoElement = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size to match video
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    
    // Draw current video frame to canvas
    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    
    // Show "Analyzing..." status
    updateDetectionStatus('ðŸ” Analyzing face...');
    
    // Convert canvas to base64 image
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Send to Flask backend
    const response = await fetch('/detect_emotion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ image: imageData })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Show face detected status
      updateDetectionStatus('âœ… Face Detected!');
      
      // Draw face detection box if coordinates provided
      if (result.faceRegion) {
        drawFaceBox(result.faceRegion);
      }
      
      // Update emotion display
      updateEmotionDisplay(result.emotion, result.confidence);
      
      // Update song recommendations
      updateRecommendationsFromEmotion(result.emotion, result.songs);
      
    } else {
      // No face detected
      updateDetectionStatus('âŒ No face detected');
      
      if (result.message && result.message.includes('No face detected')) {
        const emotionLabel = document.getElementById('emotionLabel');
        const emotionConfidence = document.getElementById('emotionConfidence');
        emotionLabel.textContent = 'No face detected';
        emotionConfidence.textContent = 'Please look at camera';
      }
    }
    
  } catch (error) {
    console.error('Error during emotion detection:', error);
    updateDetectionStatus('âš ï¸ Connection error');
    showNotification('âŒ Connection error. Is Flask server running?');
  }
}
function updateDetectionStatus(message) {
  let statusDiv = document.querySelector('.detection-status');
  if (!statusDiv) {
    // Create status div if it doesn't exist
    statusDiv = document.createElement('div');
    statusDiv.className = 'detection-status';
    document.getElementById('videoContainer').appendChild(statusDiv);
  }
  statusDiv.textContent = message;
}

function drawFaceBox(faceRegion) {
  // Remove existing face box
  const existingBox = document.querySelector('.face-box');
  if (existingBox) existingBox.remove();
  
  const existingScanner = document.querySelector('.face-scanning');
  if (existingScanner) existingScanner.remove();
  
  const videoContainer = document.getElementById('videoContainer');
  const videoElement = document.getElementById('videoElement');
  
  // Calculate position relative to video
  const videoRect = videoElement.getBoundingClientRect();
  const containerRect = videoContainer.getBoundingClientRect();
  
  // Get face coordinates
  const x = faceRegion.x || 0;
  const y = faceRegion.y || 0;
  const w = faceRegion.w || 100;
  const h = faceRegion.h || 100;
  
  // Calculate percentage positions
  const leftPercent = (x / videoElement.videoWidth) * 100;
  const topPercent = (y / videoElement.videoHeight) * 100;
  const widthPercent = (w / videoElement.videoWidth) * 100;
  const heightPercent = (h / videoElement.videoHeight) * 100;
  
  // Create face box overlay
  const faceBox = document.createElement('div');
  faceBox.className = 'face-box';
  faceBox.style.left = leftPercent + '%';
  faceBox.style.top = topPercent + '%';
  faceBox.style.width = widthPercent + '%';
  faceBox.style.height = heightPercent + '%';
  
  // Create scanning line
  const scanLine = document.createElement('div');
  scanLine.className = 'face-scanning';
  faceBox.appendChild(scanLine);
  
  videoContainer.appendChild(faceBox);
  
  // Remove face box after 2 seconds
  setTimeout(() => {
    faceBox.remove();
  }, 2000);
}


    function updateEmotionDisplay(emotion, confidence) {
      const emotionLabel = document.getElementById('emotionLabel');
      const emotionConfidence = document.getElementById('emotionConfidence');
      const emotionIcon = document.querySelector('.emotion-icon');
      
      emotionLabel.textContent = emotion;
      emotionConfidence.textContent = `Confidence: ${confidence}%`;
      emotionIcon.textContent = emotionIcons[emotion] || 'ðŸ˜Š';
    }

    function updateRecommendationsFromEmotion(emotion, emotionSongs) {
      if (!emotionSongs || emotionSongs.length === 0) return;
      
      // Transform songs to match existing format
      const transformedSongs = emotionSongs.map(song => ({
        id: song._id,
        title: song.title,
        artist: song.artist,
        img: song.coverUrl || song.cover_url || '/static/images/default-cover.jpg',
        audioUrl: song.audioUrl || song.audio_url || '',
        artistPhotoUrl: song.artistPhotoUrl || song.artist_photo_url || '',
        emotions: song.emotions || [],
        favorited: false
      }));
      
      // Add transformed songs to main songs array if not already present (for playback)
      transformedSongs.forEach(transformedSong => {
        const existingIndex = songs.findIndex(s => s.id === transformedSong.id);
        if (existingIndex === -1) {
          songs.push(transformedSong);
        } else {
          // Update existing song with new data
          songs[existingIndex] = transformedSong;
        }
      });
      
      songGridEl.innerHTML = '';
      
      const header = document.createElement('div');
      header.style.cssText = `
        grid-column: 1 / -1;
        padding: 20px;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        margin-bottom: 12px;
        text-align: center;
        border: 2px solid rgba(236, 72, 153, 0.2);
      `;
      header.innerHTML = `
        <div style="font-size: 1.4rem; font-weight: 800; margin-bottom: 10px;">
          ${emotionIcons[emotion]} ${emotion} Playlist
        </div>
        <div style="color: var(--text-secondary); font-size: 1rem; font-weight: 500;">
          Songs curated based on your current mood
        </div>
      `;
      songGridEl.appendChild(header);
      
      // Render songs using the same format as regular songs
      transformedSongs.forEach(song => {
        // Check if song is favorited
        const isFavorited = window.favoriteSongIds && window.favoriteSongIds.includes(song.id);
        
        const card = document.createElement("div");
        card.className = "song-card";
        card.innerHTML = `
          <div class="song-card-image" onclick="playSongById('${song.id}')">
            <img src="${song.img}" alt="${song.title}" loading="lazy" />
            <div class="play-overlay">
              <div class="play-button">â–¶</div>
            </div>
          </div>
          <div class="title">${song.title}</div>
          <div class="artist">${song.artist}</div>
          <div class="song-card-footer">
            <button class="song-play-btn" onclick="playSongById('${song.id}')" title="Play">â–¶</button>
            <button class="song-favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite(event, '${song.id}')" title="Favorite">
              ${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}
            </button>
            <button class="song-favorite-btn" onclick="event.stopPropagation(); openAddToPlaylistModal('${song.id}')" title="Add to Playlist" style="margin-left: 4px;">
              ðŸ“‹
            </button>
          </div>
        `;
        songGridEl.appendChild(card);
      });
      
      showNotification(`ðŸŽ­ ${emotion} mood detected! Updated playlist with ${emotionSongs.length} songs`);
    }


    async function applyManualMood() {
      const moodSelect = document.getElementById('manualMood');
      const mood = moodSelect.value;
      
      if (!mood) {
        showNotification('âš ï¸ Please select a mood first');
        return;
      }
      
      // Update emotion display
      updateEmotionDisplay(mood, 100);
      
      // Show loading state
      showNotification('ðŸ”„ Loading songs for your mood...');
      
      try {
        // Fetch songs from backend that match the selected emotion
        const response = await fetch(`/api/songs/by-emotion?emotion=${encodeURIComponent(mood)}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch songs');
        }
        
        const emotionSongs = await response.json();
        
        // Reset artist filter
        currentArtist = null;
        renderArtists();
        
        // Clear song grid
        songGridEl.innerHTML = '';
        
        if (emotionSongs && emotionSongs.length > 0) {
          // Add header
          const header = document.createElement('div');
          header.style.cssText = `
            grid-column: 1 / -1;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            text-align: center;
            border: 2px solid rgba(236, 72, 153, 0.2);
          `;
          header.innerHTML = `
            <div style="font-size: 1.4rem; font-weight: 800; margin-bottom: 10px;">
              ${emotionIcons[mood]} ${mood} Playlist
            </div>
            <div style="color: var(--text-secondary); font-size: 1rem; font-weight: 500;">
              Manually selected mood - Enjoy your personalized playlist
            </div>
          `;
          songGridEl.appendChild(header);
          
          // Transform songs to match existing format
          const transformedSongs = emotionSongs.map(song => ({
            id: song._id,
            title: song.title,
            artist: song.artist,
            img: song.coverUrl || song.cover_url || '/static/images/default-cover.jpg',
            audioUrl: song.audioUrl || song.audio_url || '',
            artistPhotoUrl: song.artistPhotoUrl || song.artist_photo_url || '',
            emotions: song.emotions || [],
            favorited: false
          }));
          
          // Add transformed songs to main songs array if not already present (for playback)
          transformedSongs.forEach(transformedSong => {
            const existingIndex = songs.findIndex(s => s.id === transformedSong.id);
            if (existingIndex === -1) {
              songs.push(transformedSong);
            } else {
              // Update existing song with new data
              songs[existingIndex] = transformedSong;
            }
          });
          
          // Render songs from backend
          transformedSongs.forEach(song => {
            const card = document.createElement("div");
            card.className = "song-card";
            
            // Check if song is favorited
            const isFavorited = window.favoriteSongIds && window.favoriteSongIds.includes(song.id);
            
            card.innerHTML = `
              <div class="song-card-image" onclick="playSongById('${song.id}')">
                <img src="${song.img}" alt="${song.title}" loading="lazy" />
                <div class="play-overlay">
                  <div class="play-button">â–¶</div>
                </div>
              </div>
              <div class="title">${song.title}</div>
              <div class="artist">${song.artist}</div>
              <div class="song-card-footer">
                <button class="song-play-btn" onclick="playSongById('${song.id}')" title="Play">â–¶</button>
                <button class="song-favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite(event, '${song.id}')" title="Favorite">
                  ${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}
                </button>
              </div>
            `;
            songGridEl.appendChild(card);
          });
          
          showNotification(`ðŸŽ­ Mood set to: ${mood}! Found ${emotionSongs.length} songs matching your mood.`);
        } else {
          // No songs found for this emotion
          songGridEl.innerHTML = `
            <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 16px;">ðŸŽµ</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 8px;">No songs found for ${mood} mood</div>
              <div style="font-size: 0.9rem;">Try selecting a different mood or check back later!</div>
            </div>
          `;
          showNotification(`âš ï¸ No songs found for ${mood} mood. Try a different mood!`);
        }
      } catch (error) {
        console.error('Error fetching songs by emotion:', error);
        showNotification('âŒ Failed to load songs. Please try again.');
        
        // Fallback: show all songs
        songGridEl.innerHTML = '';
        renderSongs();
      }
    }

    function stopFacecam() {
      if (!facecamActive) {
        showNotification('Facecam is not running');
        return;
      }

      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }

      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      
      const videoContainer = document.getElementById('videoContainer');
      videoContainer.classList.remove('active');
      
      facecamActive = false;
      
      renderSongs();
      
      showNotification('â¹ï¸ Facecam stopped');
    }

    function showNotification(message) {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // Initialize
    renderArtists();
    renderSongs();
    updateAdminVisibility();
    updateVolumeUI();
    updateProgressUI();

    // Prevent pull-to-refresh on mobile
    let touchStartY = 0;
    document.addEventListener('touchstart', e => {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchmove', e => {
      const touchY = e.touches[0].clientY;
      const touchDiff = touchY - touchStartY;
      if (touchDiff > 0 && window.scrollY === 0) {
        e.preventDefault();
      }
    }, { passive: false });

    async function detectEmotion() {
  if (!facecamActive) return;
  
  try {
    const videoElement = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size to match video
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    
    // Draw current video frame to canvas
    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    
    // Show "Analyzing..." status
    updateDetectionStatus('ðŸ” Scanning for face...');
    
    // Convert canvas to base64 image
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Send to Flask backend
    const response = await fetch('/detect_emotion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ image: imageData })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Show face detected status
      updateDetectionStatus('âœ… Face Detected! Analyzing emotion...');
      
      // Draw stylish face landmarks if coordinates provided
      if (result.faceRegion && result.landmarks) {
        drawStylishLandmarks(result.faceRegion, result.landmarks);
      } else if (result.faceRegion) {
        // Fallback to face box if no landmarks
        drawFaceBox(result.faceRegion);
      }
      
      // Wait a moment to show landmarks before updating emotion
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Update emotion display
      updateEmotionDisplay(result.emotion, result.confidence);
      
      // Update song recommendations
      updateRecommendationsFromEmotion(result.emotion, result.songs);
      
    } else {
      // No face detected
      updateDetectionStatus('âŒ No face detected - Please look at camera');
      
      if (result.message && result.message.includes('No face detected')) {
        const emotionLabel = document.getElementById('emotionLabel');
        const emotionConfidence = document.getElementById('emotionConfidence');
        emotionLabel.textContent = 'No face detected';
        emotionConfidence.textContent = 'Please position your face in view';
      }
    }
    
  } catch (error) {
    console.error('Error during emotion detection:', error);
    updateDetectionStatus('âš ï¸ Connection error');
    showNotification('âŒ Connection error. Is Flask server running?');
  }
}
function drawStylishLandmarks(faceRegion, landmarks) {
  // Remove existing landmark overlays
  const existingLandmarks = document.querySelector('.landmark-overlay');
  if (existingLandmarks) existingLandmarks.remove();
  
  const videoContainer = document.getElementById('videoContainer');
  const videoElement = document.getElementById('videoElement');
  
  const videoWidth = videoElement.videoWidth;
  const videoHeight = videoElement.videoHeight;
  
  // Create main landmark container
  const landmarkOverlay = document.createElement('div');
  landmarkOverlay.className = 'landmark-overlay';
  landmarkOverlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 6;
  `;
  
  // Draw face outline with glow effect
  if (faceRegion) {
    const x = faceRegion.x || 0;
    const y = faceRegion.y || 0;
    const w = faceRegion.w || 100;
    const h = faceRegion.h || 100;
    
    const leftPercent = (x / videoWidth) * 100;
    const topPercent = (y / videoHeight) * 100;
    const widthPercent = (w / videoWidth) * 100;
    const heightPercent = (h / videoHeight) * 100;
    
    const faceOutline = document.createElement('div');
    faceOutline.style.cssText = `
      position: absolute;
      left: ${leftPercent}%;
      top: ${topPercent}%;
      width: ${widthPercent}%;
      height: ${heightPercent}%;
      border: 2px solid #00ffff;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.8), inset 0 0 30px rgba(0, 255, 255, 0.3);
      animation: pulse-glow 2s infinite;
    `;
    landmarkOverlay.appendChild(faceOutline);
  }
  
  // Draw landmark points
  if (landmarks && landmarks.length > 0) {
    landmarks.forEach((point, index) => {
      const xPercent = (point.x / videoWidth) * 100;
      const yPercent = (point.y / videoHeight) * 100;
      
      // Create landmark point
      const landmarkPoint = document.createElement('div');
      landmarkPoint.style.cssText = `
        position: absolute;
        left: ${xPercent}%;
        top: ${yPercent}%;
        width: 6px;
        height: 6px;
        background: linear-gradient(135deg, #00ffff, #ffffff);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        animation: landmark-pulse 1.5s infinite ${index * 0.05}s;
      `;
      landmarkOverlay.appendChild(landmarkPoint);
      
      // Add connecting lines for certain landmark groups
      if (index > 0 && shouldConnectLandmarks(index)) {
        const prevPoint = landmarks[index - 1];
        const prevXPercent = (prevPoint.x / videoWidth) * 100;
        const prevYPercent = (prevPoint.y / videoHeight) * 100;
        
        const line = createLandmarkLine(prevXPercent, prevYPercent, xPercent, yPercent);
        landmarkOverlay.appendChild(line);
      }
    });
  }
  
  videoContainer.appendChild(landmarkOverlay);
  
  // Remove after 2.5 seconds
  setTimeout(() => {
    landmarkOverlay.remove();
  }, 2500);
}

function shouldConnectLandmarks(index) {
  // Connect certain landmark sequences (eyes, nose, mouth outline)
  const connectRanges = [
    [0, 16],   // Face outline
    [17, 21],  // Left eyebrow
    [22, 26],  // Right eyebrow
    [27, 35],  // Nose
    [36, 41],  // Left eye
    [42, 47],  // Right eye
    [48, 59],  // Outer mouth
    [60, 67]   // Inner mouth
  ];
  
  return connectRanges.some(range => {
    return index > range[0] && index <= range[1];
  });
}

function createLandmarkLine(x1, y1, x2, y2) {
  const line = document.createElement('div');
  
  const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
  const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
  
  line.style.cssText = `
    position: absolute;
    left: ${x1}%;
    top: ${y1}%;
    width: ${length}%;
    height: 1px;
    background: linear-gradient(90deg, rgba(0, 255, 255, 0.5), rgba(255, 255, 255, 0.5));
    transform-origin: left center;
    transform: rotate(${angle}deg);
  `;
  
  return line;
}
// Load persisted playback state
// Load persisted playback state (USER-SPECIFIC)
// Load persisted playback state (USER-SPECIFIC)
function loadPlaybackState() {
  if (!window.currentUser || !window.currentUser.id) {
    console.log('No user logged in yet');
    return;
  }
  
  const storageKey = `vibesync_playback_user_${window.currentUser.id}`;
  const savedState = localStorage.getItem(storageKey);
  
  if (savedState) {
    try {
      const state = JSON.parse(savedState);
      if (state.song) {
        // âœ… Check if songs are loaded
        if (songs.length === 0) {
          console.log('Songs not loaded yet, waiting...');
          // Songs will be loaded soon, try again after a delay
          setTimeout(() => loadPlaybackState(), 500);
          return;
        }
        
        // âœ… Find song by ID
        const songIndex = songs.findIndex(s => s.id === state.song.id);
        
        if (songIndex !== -1) {
          // Song found in current song list
          playSongById(state.song.id);
          audioPlayer.currentTime = state.currentTime || 0;
          if (!state.isPlaying) {
            audioPlayer.pause();
            isPlaying = false;
            updatePlayPauseButton();
          }
        } else {
          // âœ… Song not in current list, but we can still play it from saved data
          console.log('Song not in current list, playing from saved state');
          currentSongIndex = -1; // Mark as external song
          
          // Update UI
          document.getElementById('playerThumbnail').src = state.song.img;
          document.getElementById('playerTitle').textContent = state.song.title;
          document.getElementById('playerArtist').textContent = state.song.artist;
          document.getElementById('musicPlayer').classList.add('active');
          
          updateFullscreenPlayer(state.song);
          
          // Play audio
          audioPlayer.src = state.song.audioUrl;
          audioPlayer.currentTime = state.currentTime || 0;
          
          if (state.isPlaying) {
            audioPlayer.play().then(() => {
              isPlaying = true;
              updatePlayPauseButton();
            }).catch(err => console.log('Auto-play prevented'));
          } else {
            isPlaying = false;
            updatePlayPauseButton();
          }
        }
      }
    } catch (e) {
      console.log('Could not restore playback state:', e);
    }
  }
}
// Save playback state (USER-SPECIFIC)
function savePlaybackState() {
  if (!window.currentUser || !window.currentUser.id) {
    return;
  }
  
  if (currentSongIndex !== -1) {
    const song = songs[currentSongIndex];
    const storageKey = `vibesync_playback_user_${window.currentUser.id}`;
    localStorage.setItem(storageKey, JSON.stringify({
      song: { 
        id: song.id, 
        title: song.title, 
        artist: song.artist, 
        img: song.img, 
        audioUrl: song.audioUrl 
      },
      currentTime: audioPlayer.currentTime,
      isPlaying: isPlaying
    }));
  }
}

// Call on page load
window.addEventListener('DOMContentLoaded', loadPlaybackState);

// Save periodically
setInterval(savePlaybackState, 2000);
window.addEventListener('beforeunload', savePlaybackState);
audioPlayer.addEventListener('timeupdate', savePlaybackState);

// Run this in console on BOTH pages
console.log('ðŸ†” Current User ID:', window.currentUser?.id);
console.log('ðŸ“§ Email:', window.currentUser?.email);
console.log('ðŸ”‘ Favorites Key:', `vibesync_favorites_user_${window.currentUser?.id}`);

    // ========================================
    // PLAYLIST FUNCTIONS
    // ========================================
    // ========================================
// PLAYLIST FUNCTIONS (FIXED)
// ========================================
let allPlaylists = [];
let currentSongForPlaylist = null;

// Load playlists from backend API
async function loadPlaylists() {
  if (!window.currentUser || !window.currentUser.id) {
    console.log('No user logged in');
    return [];
  }
  
  try {
    const response = await fetch('/api/playlists');
    if (!response.ok) {
      throw new Error('Failed to load playlists');
    }
    
    allPlaylists = await response.json();
    console.log('âœ… Loaded playlists from backend:', allPlaylists.length);
    return allPlaylists;
  } catch (e) {
    console.error('Error loading playlists:', e);
    allPlaylists = [];
    return [];
  }
}

// Open create playlist modal
function openCreatePlaylistModal() {
  toggleSidebar(); // Close sidebar first
  document.getElementById('newPlaylistName').value = '';
  document.getElementById('newPlaylistDescription').value = '';
  document.getElementById('createPlaylistModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close create playlist modal
function closeCreatePlaylistModal() {
  document.getElementById('createPlaylistModal').classList.remove('active');
  document.body.style.overflow = '';
}

// Save new playlist - FIXED VERSION
async function saveNewPlaylist(event) {
  event.preventDefault();

  const name = document.getElementById('newPlaylistName').value.trim();
  const description = document.getElementById('newPlaylistDescription').value.trim();

  if (!name) {
    showNotification('âŒ Please enter a playlist name');
    return;
  }

  try {
    showNotification('Creating playlist...');
    
    const response = await fetch('/api/playlists', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to create playlist');
    }
    
    console.log('âœ… Playlist created successfully:', data.playlist);
    
    showNotification('âœ… Playlist created successfully!');
    closeCreatePlaylistModal();
    
    // ðŸ”§ FIX: Reload playlists array FIRST
    await loadPlaylists();
    
    // ðŸ”§ FIX: Then force reload the playlist section
    const playlistSection = document.getElementById('playlistSection');
    if (playlistSection && playlistSection.classList.contains('active')) {
      // If we're currently viewing playlists, reload the view
      const container = document.getElementById('playlistContent');
      if (container) {
        container.dataset.loaded = 'false';
        await loadPlaylistSection();
      }
    }
    
    // If we have a song waiting to be added, add it now
    if (currentSongForPlaylist && data.playlist && data.playlist.id) {
      await addSongToPlaylist(data.playlist.id, currentSongForPlaylist);
      currentSongForPlaylist = null;
    }
  } catch (error) {
    console.error('Error creating playlist:', error);
    showNotification('âŒ Failed to create playlist: ' + error.message);
  }
}

// Open add to playlist modal
async function openAddToPlaylistModal(songId) {
  if (!window.currentUser || !window.currentUser.id) {
    showNotification('Please login first');
    return;
  }

  const song = songs.find(s => s.id === songId);
  if (!song) {
    showNotification('Song not found');
    return;
  }

  currentSongForPlaylist = {
    id: song.id,
    title: song.title,
    artist: song.artist,
    coverUrl: song.img,
    audioUrl: song.audioUrl || '',
    artistPhotoUrl: song.artistPhotoUrl || '',
    img: song.img
  };

  // ðŸ”§ FIX: Always reload playlists when opening modal
  await loadPlaylists();
  renderPlaylistsForModal();
  
  document.getElementById('addToPlaylistModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close add to playlist modal
function closeAddToPlaylistModal() {
  document.getElementById('addToPlaylistModal').classList.remove('active');
  document.body.style.overflow = '';
  currentSongForPlaylist = null;
}

// Render playlists in the modal
function renderPlaylistsForModal() {
  const container = document.getElementById('playlistsList');
  
  if (allPlaylists.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“‹</div>
        <h3 style="margin-bottom: 8px; color: var(--text-primary);">No playlists yet</h3>
        <p style="color: var(--text-secondary);">Create your first playlist to add songs!</p>
      </div>
    `;
    return;
  }

  container.innerHTML = allPlaylists.map(playlist => {
    const songCount = playlist.songs ? playlist.songs.length : 0;
    const hasSong = currentSongForPlaylist && playlist.songs && 
                   playlist.songs.some(s => s.id === currentSongForPlaylist.id);
    
    return `
      <div class="playlist-item ${hasSong ? 'style="opacity: 0.6;"' : ''}" onclick="${hasSong ? '' : `addSongToPlaylist(${playlist.id}, currentSongForPlaylist)`}">
        <div class="playlist-item-info">
          <div class="playlist-item-name">${escapeHtml(playlist.name)}</div>
          <div class="playlist-item-meta">${songCount} ${songCount === 1 ? 'song' : 'songs'}${playlist.description ? ' â€¢ ' + escapeHtml(playlist.description) : ''}</div>
        </div>
        ${hasSong ? '<span style="color: var(--accent-primary); font-size: 20px;">âœ“</span>' : '<span style="color: var(--text-muted); font-size: 20px;">â†’</span>'}
      </div>
    `;
  }).join('');
}

// Add song to playlist
async function addSongToPlaylist(playlistId, songData) {
  if (!songData) {
    showNotification('No song selected');
    return;
  }

  const playlist = allPlaylists.find(p => p.id == playlistId);
  if (!playlist) {
    showNotification('Playlist not found');
    return;
  }

  // Check if song already exists
  if (playlist.songs && playlist.songs.some(s => s.id === songData.id)) {
    showNotification('âœ… Song already in playlist');
    closeAddToPlaylistModal();
    return;
  }

  try {
    const response = await fetch(`/api/playlists/${playlistId}/songs`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        songId: songData.id,
        title: songData.title,
        artist: songData.artist,
        coverUrl: songData.coverUrl || songData.img,
        audioUrl: songData.audioUrl || '',
        artistPhotoUrl: songData.artistPhotoUrl || ''
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to add song to playlist');
    }
    
    // Reload playlists to get updated data
    await loadPlaylists();
    
    showNotification(`âœ… Added "${songData.title}" to "${playlist.name}"`);
    closeAddToPlaylistModal();
    
    // If playlist section is active, reload it
    const playlistSection = document.getElementById('playlistSection');
    if (playlistSection && playlistSection.classList.contains('active')) {
      const container = document.getElementById('playlistContent');
      if (container) {
        container.dataset.loaded = 'false';
        await loadPlaylistSection();
      }
    }
  } catch (error) {
    console.error('Error adding song to playlist:', error);
    showNotification('âŒ Failed to add song to playlist');
  }
}

// Helper function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Load playlists section - IMPROVED VERSION
async function loadPlaylistSection() {
  const container = document.getElementById('playlistContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading playlists...</div></div>';
  
  try {
    // ðŸ”§ FIX: Always fetch fresh data
    await loadPlaylists();
    const playlists = allPlaylists;
    
    if (playlists.length === 0) {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>ðŸ“‹ Your Playlists</h2>
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“‹</div>
              <h3>No playlists yet</h3>
              <p>Create your first playlist to organize your music</p>
              <button class="play-btn" onclick="openCreatePlaylistModal()" style="margin-top: 20px;">âž• Create Playlist</button>
            </div>
          </div>
        </div>
      `;
    } else {
      let html = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2>ðŸ“‹ Your Playlists (${playlists.length})</h2>
              <button class="play-btn" onclick="openCreatePlaylistModal()">âž• Create New</button>
            </div>
      `;
      
      playlists.forEach(playlist => {
        const songCount = playlist.songs ? playlist.songs.length : 0;
        const coverImage = playlist.songs && playlist.songs.length > 0 
          ? playlist.songs[0].coverUrl 
          : 'https://picsum.photos/400/400?random=playlist';
        
        html += `
          <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.08);">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
              <img src="${coverImage}" alt="${playlist.name}" style="width: 120px; height: 120px; border-radius: var(--radius-md); object-fit: cover;">
              <div style="flex: 1;">
                <h3 style="margin: 0 0 8px 0; font-size: 1.5rem;">${escapeHtml(playlist.name)}</h3>
                <p style="color: var(--text-secondary); margin: 0 0 12px 0;">${escapeHtml(playlist.description) || 'No description'}</p>
                <p style="color: var(--text-muted); font-size: 14px; margin: 0;">${songCount} ${songCount === 1 ? 'song' : 'songs'}</p>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                  <button class="small-btn" onclick="playPlaylist(${playlist.id})">â–¶ Play All</button>
                  <button class="small-btn" onclick="deletePlaylist(${playlist.id})" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">ðŸ—‘ï¸ Delete</button>
                </div>
              </div>
            </div>
            ${songCount > 0 ? `
              <div class="grid">
                ${playlist.songs.map(song => `
                  <div class="song-card">
                    <div class="song-card-image" onclick="playSongById('${song.id}')">
                      <img src="${song.coverUrl}" alt="${song.title}" loading="lazy" />
                      <div class="play-overlay">
                        <div class="play-button">â–¶</div>
                      </div>
                    </div>
                    <div class="title">${escapeHtml(song.title)}</div>
                    <div class="artist">${escapeHtml(song.artist)}</div>
                    <div class="song-card-footer">
                      <button class="song-play-btn" onclick="playSongById('${song.id}')" title="Play">â–¶</button>
                      <button class="song-favorite-btn" onclick="removeSongFromPlaylist(${playlist.id}, '${song.id}')" title="Remove from playlist" style="border-color: rgba(239, 68, 68, 0.3);">
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No songs in this playlist yet</p>'}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    container.dataset.loaded = 'true';
    console.log('âœ… Playlist section loaded with', playlists.length, 'playlists');
  } catch (error) {
    console.error('Error loading playlists:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading playlists</h3>
          <p>Please try again</p>
          <button class="play-btn" onclick="loadPlaylistSection(); container.dataset.loaded = false;">Retry</button>
        </div>
      </div>
    `;
  }
}

async function deletePlaylist(playlistId) {
  if (!confirm('Delete this playlist? This cannot be undone.')) return;
  
  try {
    const response = await fetch(`/api/playlists/${playlistId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to delete playlist');
    
    showNotification('âœ… Playlist deleted');
    
    // Reload playlists
    await loadPlaylists();
    
    // Reload section
    document.getElementById('playlistContent').dataset.loaded = 'false';
    await loadPlaylistSection();
  } catch (error) {
    console.error('Error deleting playlist:', error);
    showNotification('âŒ Failed to delete playlist');
  }
}

async function removeSongFromPlaylist(playlistId, songId) {
  if (!confirm('Remove this song from the playlist?')) return;
  
  try {
    const response = await fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to remove song');
    
    showNotification('âœ… Song removed from playlist');
    
    // Reload playlists
    await loadPlaylists();
    
    // Reload section
    document.getElementById('playlistContent').dataset.loaded = 'false';
    await loadPlaylistSection();
  } catch (error) {
    console.error('Error removing song:', error);
    showNotification('âŒ Failed to remove song');
  }
}

function playPlaylist(playlistId) {
  // Find playlist and play first song
  const playlist = allPlaylists.find(p => p.id == playlistId);
  if (playlist && playlist.songs && playlist.songs.length > 0) {
    playSongById(playlist.songs[0].id);
    showNotification(`â–¶ Playing playlist: ${playlist.name}`);
  } else {
    showNotification('âŒ Playlist is empty');
  }
}

// Load playlists on authentication
if (window.currentUser && window.currentUser.id) {
  loadPlaylists();
}

    // ========================================
// SPA SECTION LOADERS (FIXED)
// ========================================

async function loadFavoritesSection() {
  const container = document.getElementById('favoritesContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading favorites...</div></div>';
  
  try {
    const response = await fetch('/api/favorites');
    if (!response.ok) throw new Error('Failed to load favorites');
    
    const favorites = await response.json();
    
    if (favorites.length === 0) {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>â¤ï¸ Your Favorites</h2>
            <div class="empty-state" style="grid-column: 1 / -1;">
              <div class="empty-state-icon">â¤ï¸</div>
              <h3>No favorites yet</h3>
              <p>Songs you favorite will appear here</p>
            </div>
          </div>
        </div>
      `;
    } else {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>â¤ï¸ Your Favorites (${favorites.length})</h2>
            <div class="grid" id="favoritesGrid"></div>
          </div>
        </div>
      `;
      
      const grid = container.querySelector('#favoritesGrid');
      favorites.forEach(song => {
        const card = document.createElement("div");
        card.className = "song-card";
        card.innerHTML = `
          <div class="song-card-image" onclick="playSongById('${song.id}')">
            <img src="${song.coverUrl}" alt="${song.title}" loading="lazy" />
            <div class="play-overlay">
              <div class="play-button">â–¶</div>
            </div>
          </div>
          <div class="title">${song.title}</div>
          <div class="artist">${song.artist}</div>
          <div class="song-card-footer">
            <button class="song-play-btn" onclick="playSongById('${song.id}')" title="Play">â–¶</button>
            <button class="song-favorite-btn favorited" onclick="toggleFavorite(event, '${song.id}')" title="Remove from favorites">
              â¤ï¸
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    container.dataset.loaded = 'true';
    console.log('âœ… Favorites section loaded');
  } catch (error) {
    console.error('Error loading favorites:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading favorites</h3>
          <p>Please try again</p>
          <button class="play-btn" onclick="loadFavoritesSection(); container.dataset.loaded = false;">Retry</button>
        </div>
      </div>
    `;
  }
}

async function loadRecentlySection() {
  const container = document.getElementById('recentlyContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading recently played...</div></div>';
  
  try {
    const response = await fetch('/api/recently-played');
    if (!response.ok) throw new Error('Failed to load recently played');
    
    const history = await response.json();
    
    if (history.length === 0) {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>ðŸ• Recently Played</h2>
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ•</div>
              <h3>No history yet</h3>
              <p>Songs you play will appear here</p>
            </div>
          </div>
        </div>
      `;
    } else {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2>ðŸ• Recently Played (${history.length})</h2>
              <button class="small-btn" onclick="clearAllHistory()" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
                ðŸ—‘ï¸ Clear All
              </button>
            </div>
            <div class="grid" id="recentlyGrid"></div>
          </div>
        </div>
      `;
      
      const grid = container.querySelector('#recentlyGrid');
      history.forEach(item => {
        const card = document.createElement("div");
        card.className = "song-card";
        card.innerHTML = `
          <div class="song-card-image" onclick="playSongById('${item.songId}')">
            <img src="${item.coverUrl}" alt="${item.title}" loading="lazy" />
            <div class="play-overlay">
              <div class="play-button">â–¶</div>
            </div>
          </div>
          <div class="title">${item.title}</div>
          <div class="artist">${item.artist}</div>
          <div class="song-card-footer">
            <button class="song-play-btn" onclick="playSongById('${item.songId}')" title="Play">â–¶</button>
            <button class="song-favorite-btn" onclick="deleteHistoryItem('${item.songId}', '${item.playedAt}')" title="Remove from history" style="border-color: rgba(239, 68, 68, 0.3);">
              ðŸ—‘ï¸
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    container.dataset.loaded = 'true';
    console.log('âœ… Recently section loaded');
  } catch (error) {
    console.error('Error loading recently played:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading history</h3>
          <p>Please try again</p>
          <button class="play-btn" onclick="loadRecentlySection(); container.dataset.loaded = false;">Retry</button>
        </div>
      </div>
    `;
  }
}

async function deleteHistoryItem(songId, playedAt) {
  if (!confirm('Remove this song from history?')) return;
  
  try {
    const response = await fetch('/api/recently-played/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ songId, playedAt })
    });
    
    if (!response.ok) throw new Error('Failed to delete');
    
    showNotification('âœ… Removed from history');
    document.getElementById('recentlyContent').dataset.loaded = 'false';
    loadRecentlySection();
  } catch (error) {
    console.error('Error deleting history item:', error);
    showNotification('âŒ Failed to delete');
  }
}

async function clearAllHistory() {
  if (!confirm('Clear all recently played history? This cannot be undone.')) return;
  
  try {
    const response = await fetch('/api/recently-played/clear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) throw new Error('Failed to clear history');
    
    const data = await response.json();
    showNotification(`âœ… Cleared ${data.deletedCount} items`);
    document.getElementById('recentlyContent').dataset.loaded = 'false';
    loadRecentlySection();
  } catch (error) {
    console.error('Error clearing history:', error);
    showNotification('âŒ Failed to clear history');
  }
}

async function loadPlaylistSection() {
  const container = document.getElementById('playlistContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading playlists...</div></div>';
  
  try {
    const response = await fetch('/api/playlists');
    if (!response.ok) throw new Error('Failed to load playlists');
    
    const playlists = await response.json();
    
    if (playlists.length === 0) {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>ðŸ“‹ Your Playlists</h2>
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“‹</div>
              <h3>No playlists yet</h3>
              <p>Create your first playlist to organize your music</p>
              <button class="play-btn" onclick="openCreatePlaylistModal()" style="margin-top: 20px;">âž• Create Playlist</button>
            </div>
          </div>
        </div>
      `;
    } else {
      let html = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2>ðŸ“‹ Your Playlists (${playlists.length})</h2>
              <button class="play-btn" onclick="openCreatePlaylistModal()">âž• Create New</button>
            </div>
      `;
      
      playlists.forEach(playlist => {
        const songCount = playlist.songs ? playlist.songs.length : 0;
        const coverImage = playlist.songs && playlist.songs.length > 0 
          ? playlist.songs[0].coverUrl 
          : 'https://picsum.photos/400/400?random=playlist';
        
        html += `
          <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.08);">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
              <img src="${coverImage}" alt="${playlist.name}" style="width: 120px; height: 120px; border-radius: var(--radius-md); object-fit: cover;">
              <div style="flex: 1;">
                <h3 style="margin: 0 0 8px 0; font-size: 1.5rem;">${playlist.name}</h3>
                <p style="color: var(--text-secondary); margin: 0 0 12px 0;">${playlist.description || 'No description'}</p>
                <p style="color: var(--text-muted); font-size: 14px; margin: 0;">${songCount} ${songCount === 1 ? 'song' : 'songs'}</p>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                  <button class="small-btn" onclick="playPlaylist(${playlist.id})">â–¶ Play All</button>
                  <button class="small-btn" onclick="deletePlaylist(${playlist.id})" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">ðŸ—‘ï¸ Delete</button>
                </div>
              </div>
            </div>
            ${songCount > 0 ? `
              <div class="grid">
                ${playlist.songs.map(song => `
                  <div class="song-card">
                    <div class="song-card-image" onclick="playSongById('${song.id}')">
                      <img src="${song.coverUrl}" alt="${song.title}" loading="lazy" />
                      <div class="play-overlay">
                        <div class="play-button">â–¶</div>
                      </div>
                    </div>
                    <div class="title">${song.title}</div>
                    <div class="artist">${song.artist}</div>
                    <div class="song-card-footer">
                      <button class="song-play-btn" onclick="playSongById('${song.id}')" title="Play">â–¶</button>
                      <button class="song-favorite-btn" onclick="removeSongFromPlaylist(${playlist.id}, '${song.id}')" title="Remove from playlist" style="border-color: rgba(239, 68, 68, 0.3);">
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No songs in this playlist yet</p>'}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    container.dataset.loaded = 'true';
    console.log('âœ… Playlist section loaded');
  } catch (error) {
    console.error('Error loading playlists:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading playlists</h3>
          <p>Please try again</p>
          <button class="play-btn" onclick="loadPlaylistSection(); container.dataset.loaded = false;">Retry</button>
        </div>
      </div>
    `;
  }
}

async function deletePlaylist(playlistId) {
  if (!confirm('Delete this playlist? This cannot be undone.')) return;
  
  try {
    const response = await fetch(`/api/playlists/${playlistId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to delete playlist');
    
    showNotification('âœ… Playlist deleted');
    document.getElementById('playlistContent').dataset.loaded = 'false';
    loadPlaylistSection();
  } catch (error) {
    console.error('Error deleting playlist:', error);
    showNotification('âŒ Failed to delete playlist');
  }
}

async function removeSongFromPlaylist(playlistId, songId) {
  if (!confirm('Remove this song from the playlist?')) return;
  
  try {
    const response = await fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to remove song');
    
    showNotification('âœ… Song removed from playlist');
    document.getElementById('playlistContent').dataset.loaded = 'false';
    loadPlaylistSection();
  } catch (error) {
    console.error('Error removing song:', error);
    showNotification('âŒ Failed to remove song');
  }
}

function playPlaylist(playlistId) {
  // Find playlist and play first song
  fetch('/api/playlists')
    .then(res => res.json())
    .then(playlists => {
      const playlist = playlists.find(p => p.id == playlistId);
      if (playlist && playlist.songs && playlist.songs.length > 0) {
        playSongById(playlist.songs[0].id);
        showNotification(`â–¶ Playing playlist: ${playlist.name}`);
      } else {
        showNotification('âŒ Playlist is empty');
      }
    });
}

async function loadProfileSection() {
  const container = document.getElementById('profileContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading profile...</div></div>';
  
  try {
    const response = await fetch('/api/auth/me');
    if (!response.ok) throw new Error('Failed to load profile');
    
    const user = await response.json();
    
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="section">
          <h2>ðŸ‘¤ Your Profile</h2>
          
          <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.08);">
            <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
              <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--gradient-hero); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
                ${user.firstName.charAt(0)}
              </div>
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 1.8rem;">${user.firstName} ${user.lastName}</h3>
                <p style="color: var(--text-secondary); margin: 0;">${user.email}</p>
                ${user.isAdmin ? '<p style="color: var(--accent-primary); margin: 8px 0 0 0; font-weight: 700;">ðŸ‘‘ Admin</p>' : ''}
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 20px 0; border-top: 1px solid rgba(255,255,255,0.08);">
              <div style="text-align: center;">
                <div style="font-size: 2rem; color: var(--accent-primary); margin-bottom: 8px;">ðŸ“…</div>
                <div style="color: var(--text-muted); font-size: 14px;">Member Since</div>
                <div style="font-weight: 700; margin-top: 4px;">${new Date(user.createdAt).toLocaleDateString()}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 2rem; color: var(--accent-primary); margin-bottom: 8px;">ðŸ•</div>
                <div style="color: var(--text-muted); font-size: 14px;">Last Login</div>
                <div style="font-weight: 700; margin-top: 4px;">${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</div>
              </div>
            </div>
          </div>
          
          <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin: 0 0 20px 0;">Edit Profile</h3>
            <form id="profileForm" onsubmit="updateProfile(event)">
              <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" id="profileFirstName" class="form-input" value="${user.firstName}" required />
              </div>
              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" id="profileLastName" class="form-input" value="${user.lastName}" required />
              </div>
              <div class="form-group">
                <label class="form-label">Email (cannot be changed)</label>
                <input type="email" class="form-input" value="${user.email}" disabled style="opacity: 0.6; cursor: not-allowed;" />
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">ðŸ’¾ Save Changes</button>
            </form>
          </div>
          
          <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 32px; border: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin: 0 0 20px 0;">Change Password</h3>
            <form id="passwordForm" onsubmit="changePassword(event)">
              <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" id="currentPassword" class="form-input" required />
              </div>
              <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-input" minlength="8" required />
              </div>
              <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-input" minlength="8" required />
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">ðŸ”’ Change Password</button>
            </form>
          </div>
        </div>
      </div>
    `;
    
    container.dataset.loaded = 'true';
    console.log('âœ… Profile section loaded');
  } catch (error) {
    console.error('Error loading profile:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading profile</h3>
          <p>Please try again</p>
          <button class="play-btn" onclick="loadProfileSection(); container.dataset.loaded = false;">Retry</button>
        </div>
      </div>
    `;
  }
}

async function updateProfile(event) {
  event.preventDefault();
  
  const firstName = document.getElementById('profileFirstName').value.trim();
  const lastName = document.getElementById('profileLastName').value.trim();
  
  try {
    const response = await fetch('/api/profile', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ firstName, lastName })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to update profile');
    }
    
    showNotification('âœ… Profile updated successfully');
    window.currentUser.firstName = firstName;
    window.currentUser.lastName = lastName;
  } catch (error) {
    console.error('Error updating profile:', error);
    showNotification('âŒ ' + error.message);
  }
}

async function changePassword(event) {
  event.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword !== confirmPassword) {
    showNotification('âŒ Passwords do not match');
    return;
  }
  
  try {
    const response = await fetch('/api/profile/password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currentPassword, newPassword })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to change password');
    }
    
    showNotification('âœ… Password changed successfully');
    document.getElementById('passwordForm').reset();
  } catch (error) {
    console.error('Error changing password:', error);
    showNotification('âŒ ' + error.message);
  }
}

async function loadAdminSection() {
  const container = document.getElementById('adminContent');
  if (!container) return;
  
  if (!isAdmin) {
    container.innerHTML = '<div class="empty-state" style="padding: 60px 20px; text-align: center;"><h3>âŒ Admin access denied</h3></div>';
    return;
  }
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading admin panel...</div></div>';
  
  try {
    // Load admin stats, songs, and users
    const [statsRes, songsRes, usersRes] = await Promise.all([
      fetch('/api/admin/stats'),
      fetch('/api/songs'),
      fetch('/api/admin/users')
    ]);
    
    const stats = await statsRes.json();
    const allAdminSongs = await songsRes.json();
    const allAdminUsers = await usersRes.json();
    
    // Render admin panel HTML
    container.innerHTML = `
      <div style="padding: 40px 20px; min-height: 100vh; background: linear-gradient(135deg, #0f111a 0%, #0a0e1a 50%, #0f111a 100%);">
        <div style="max-width: 1400px; margin: 0 auto;">
          
          <!-- Header -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <div>
              <h1 style="font-size: 2rem; margin: 0 0 0.5rem 0;">ðŸŽµ Admin Dashboard</h1>
              <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Manage users, songs, and analytics</p>
            </div>
            <div style="display: flex; gap: 12px;">
              <button class="small-btn" onclick="refreshAdminData()">ðŸ”„ Refresh</button>
            </div>
          </div>

          <!-- Tabs -->
          <div style="display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px;">
            <button class="admin-tab active" data-tab="overview" onclick="switchAdminTab('overview')">ðŸ“Š Overview</button>
            <button class="admin-tab" data-tab="users" onclick="switchAdminTab('users')">ðŸ‘¥ Users</button>
            <button class="admin-tab" data-tab="songs" onclick="switchAdminTab('songs')">ðŸŽµ Songs</button>
          </div>

          <!-- Overview Tab -->
          <div id="adminOverviewTab" class="admin-tab-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
              <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">ðŸ‘¥</div>
                <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">${stats.totalUsers}</div>
                <div style="opacity: 0.9; font-size: 0.875rem;">Total Users</div>
              </div>
              
              <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">ðŸŽµ</div>
                <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">${stats.totalSongs}</div>
                <div style="opacity: 0.9; font-size: 0.875rem;">Total Songs</div>
              </div>
              
              <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">â–¶ï¸</div>
                <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">${stats.totalPlays}</div>
                <div style="opacity: 0.9; font-size: 0.875rem;">Total Plays</div>
              </div>
              
              <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <div style="font-size: 2.5rem; margin-bottom: 8px;">ðŸ˜Š</div>
                <div style="font-size: 2rem; font-weight: 800; margin-bottom: 4px;">${stats.totalEmotions}</div>
                <div style="opacity: 0.9; font-size: 0.875rem;">Emotions Detected</div>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div id="adminUsersTab" class="admin-tab-content" style="display: none;">
            <div style="background: var(--bg-secondary); border-radius: 20px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08);">
              <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 600; color: var(--accent-primary);">ðŸ‘¥ Registered Users (${allAdminUsers.length})</h3>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead style="background: rgba(255,255,255,0.05);">
                    <tr>
                      <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.1);">Email</th>
                      <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.1);">Name</th>
                      <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.1);">Status</th>
                      <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 1px solid rgba(255,255,255,0.1);">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${allAdminUsers.map(user => `
                      <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 12px; word-break: break-all;">${user.email}</td>
                        <td style="padding: 12px;">${user.firstName} ${user.lastName}</td>
                        <td style="padding: 12px;">
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ${user.isActive ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${user.isActive ? '#22c55e' : '#ef4444'};">
                            ${user.isActive ? 'âœ… Active' : 'ðŸš« Inactive'}
                          </span>
                          ${user.isAdmin ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: rgba(236,72,153,0.2); color: #ec4899; margin-left: 8px;">ðŸ‘‘ Admin</span>' : ''}
                        </td>
                        <td style="padding: 12px;">
                          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="small-btn" onclick="viewUserDetailsAdmin(${user.id})">ðŸ‘ï¸ View</button>
                            ${!user.isAdmin ? `
                              <button class="small-btn" onclick="toggleUserStatusAdmin(${user.id}, ${user.isActive})" style="background: ${user.isActive ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; border-color: ${user.isActive ? 'rgba(239, 68, 68, 0.3)' : 'rgba(34, 197, 94, 0.3)'}; color: ${user.isActive ? '#ef4444' : '#22c55e'};">
                                ${user.isActive ? 'Disable' : 'Enable'}
                              </button>
                            ` : '<span style="color: var(--text-muted); font-size: 0.875rem;">Protected</span>'}
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Songs Tab -->
          <div id="adminSongsTab" class="admin-tab-content" style="display: none;">
            <!-- Add Song Form -->
            <div style="background: var(--bg-secondary); border-radius: 20px; padding: 28px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08);">
              <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 600; color: var(--accent-primary);">âž• Add New Song</h3>
              <form id="adminAddSongForm" onsubmit="addSongAdmin(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                  <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="adminSongTitle" class="form-input" required placeholder="Song title" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Artist *</label>
                    <input type="text" id="adminSongArtist" class="form-input" required placeholder="Artist name" />
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Cover Image URL</label>
                  <input type="url" id="adminSongCover" class="form-input" placeholder="https://example.com/cover.jpg" />
                </div>

                <div class="form-group">
                  <label class="form-label">Audio URL *</label>
                  <input type="url" id="adminSongAudio" class="form-input" required placeholder="https://example.com/song.mp3" />
                </div>

                <div class="form-group">
                  <label class="form-label">Artist Photo URL</label>
                  <input type="url" id="adminArtistPhoto" class="form-input" placeholder="https://example.com/artist.jpg" />
                </div>

                <div class="form-group">
                  <label class="form-label">Emotions * (Select at least one)</label>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    ${['happy', 'sad', 'angry', 'surprise', 'fear', 'disgust', 'neutral'].map(emotion => `
                      <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" name="adminEmotions" value="${emotion}" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                        <span>${emotionIcons[emotion.charAt(0).toUpperCase() + emotion.slice(1)] || 'ðŸ˜Š'} ${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</span>
                      </label>
                    `).join('')}
                  </div>
                </div>

                <button type="submit" class="play-btn" style="width: 100%; margin-top: 16px;">âž• Add Song</button>
              </form>
            </div>

            <!-- Songs List -->
            <div style="background: var(--bg-secondary); border-radius: 20px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08);">
              <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 600; color: var(--accent-primary);">ðŸŽµ All Songs in Database (${allAdminSongs.length})</h3>
              <div style="display: grid; gap: 12px; max-height: 500px; overflow-y: auto;">
                ${allAdminSongs.map(song => `
                  <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; gap: 12px;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; margin-bottom: 4px;">${song.title}</div>
                      <div style="font-size: 0.875rem; color: var(--text-secondary);">${song.artist} â€¢ Emotions: ${song.emotions.join(', ')}</div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                      <button class="small-btn" onclick="editSongAdmin('${song._id}')">âœï¸ Edit</button>
                      <button class="small-btn" onclick="deleteSongAdmin('${song._id}', '${song.title}')" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">ðŸ—‘ï¸ Delete</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

        </div>
      </div>
    `;

    // Add admin-specific styles
    const style = document.createElement('style');
    style.textContent = `
      .admin-tab {
        padding: 10px 20px;
        background: rgba(255,255,255,0.05);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
        color: var(--text-primary);
        font-family: inherit;
      }
      
      .admin-tab.active {
        background: linear-gradient(135deg, #ec4899, #db2777);
        border-color: #ec4899;
        color: white;
      }
      
      .admin-tab:hover:not(.active) {
        border-color: #ec4899;
        background: rgba(236, 72, 153, 0.1);
      }
    `;
    container.appendChild(style);
    
    container.dataset.loaded = 'true';
    console.log('âœ… Admin section loaded');
    
  } catch (error) {
    console.error('Error loading admin section:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <h3>Error loading admin panel</h3>
          <p>${error.message}</p>
          <button class="play-btn" onclick="container.dataset.loaded = false; loadAdminSection();" style="margin-top: 20px;">ðŸ”„ Retry</button>
        </div>
      </div>
    `;
  }
}

// Admin tab switching
function switchAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.admin-tab[data-tab="${tab}"]`).classList.add('active');
  
  document.querySelectorAll('.admin-tab-content').forEach(t => t.style.display = 'none');
  document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
}

// Refresh admin data
async function refreshAdminData() {
  const container = document.getElementById('adminContent');
  container.dataset.loaded = 'false';
  await loadAdminSection();
  showNotification('âœ… Data refreshed');
}

// Add song (admin)
async function addSongAdmin(event) {
  event.preventDefault();
  
  const title = document.getElementById('adminSongTitle').value.trim();
  const artist = document.getElementById('adminSongArtist').value.trim();
  const coverUrl = document.getElementById('adminSongCover').value.trim();
  const audioUrl = document.getElementById('adminSongAudio').value.trim();
  const artistPhotoUrl = document.getElementById('adminArtistPhoto').value.trim();
  
  const emotions = Array.from(document.querySelectorAll('input[name="adminEmotions"]:checked'))
    .map(cb => cb.value);
  
  if (emotions.length === 0) {
    showNotification('âš ï¸ Please select at least one emotion');
    return;
  }
  
  try {
    const response = await fetch('/api/songs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title,
        artist,
        coverUrl: coverUrl || `https://picsum.photos/400/400?random=${Date.now()}`,
        audioUrl,
        artistPhotoUrl,
        emotions
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to add song');
    }
    
    showNotification('âœ… Song added successfully');
    document.getElementById('adminAddSongForm').reset();
    
    // Reload admin section
    document.getElementById('adminContent').dataset.loaded = 'false';
    await loadAdminSection();
    switchAdminTab('songs');
    
    // Reload songs on home page
    await loadSongsFromDatabase();
    
  } catch (error) {
    console.error('Error adding song:', error);
    showNotification('âŒ ' + error.message);
  }
}

// Delete song (admin)
async function deleteSongAdmin(songId, songTitle) {
  if (!confirm(`Delete "${songTitle}"? This cannot be undone.`)) return;
  
  try {
    const response = await fetch(`/api/songs/${songId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to delete song');
    
    showNotification('ðŸ—‘ï¸ Song deleted');
    
    // Reload admin section
    document.getElementById('adminContent').dataset.loaded = 'false';
    await loadAdminSection();
    switchAdminTab('songs');
    
    // Reload songs on home page
    await loadSongsFromDatabase();
    
  } catch (error) {
    console.error('Error deleting song:', error);
    showNotification('âŒ Failed to delete song');
  }
}

// Edit song (admin)
function editSongAdmin(songId) {
  showNotification('âœï¸ Edit feature coming soon!');
}

// Toggle user status (admin)
async function toggleUserStatusAdmin(userId, currentStatus) {
  const action = currentStatus ? 'disable' : 'enable';
  if (!confirm(`Are you sure you want to ${action} this user?`)) return;
  
  try {
    const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
      method: 'POST'
    });
    
    if (!response.ok) throw new Error('Failed to toggle user status');
    
    showNotification(`âœ… User ${action}d successfully`);
    
    // Reload admin section
    document.getElementById('adminContent').dataset.loaded = 'false';
    await loadAdminSection();
    switchAdminTab('users');
    
  } catch (error) {
    console.error('Error toggling user status:', error);
    showNotification('âŒ Failed to update user');
  }
}

// View user details (admin)
function viewUserDetailsAdmin(userId) {
  showNotification('ðŸ‘ï¸ User details feature coming soon!');
}
// Language Modal Functions
async function openLanguageModal() {
  document.getElementById('languageModal').classList.add('active');
  document.body.style.overflow = 'hidden';
  
  await loadLanguageCategories();
}

function closeLanguageModal() {
  document.getElementById('languageModal').classList.remove('active');
  document.body.style.overflow = '';
}

async function loadLanguagesSection() {
  const container = document.getElementById('languagesContent');
  if (!container) return;
  
  container.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="loading">Loading languages...</div></div>';
  
  try {
    // Get all available languages
    const languagesResponse = await fetch('/api/songs/languages');
    const languages = await languagesResponse.json();
    
    if (languages.length === 0) {
      container.innerHTML = `
        <div style="padding: 60px 20px; min-height: 100vh;">
          <div class="section">
            <h2>ðŸŒ Browse by Language</h2>
            <div class="empty-state">
              <div class="empty-state-icon">ðŸŒ</div>
              <h3>No languages available yet</h3>
              <p>Songs will appear here once added with language tags</p>
            </div>
          </div>
        </div>
      `;
      return;
    }
    
    // Language flag emojis and colors
    const languageData = {
      'English': { flag: 'ðŸ‡¬ðŸ‡§', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      'Hindi': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
      'Punjabi': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
      'Tamil': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
      'Telugu': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
      'Bengali': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' },
      'Marathi': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
      'Gujarati': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
      'Kannada': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
      'Malayalam': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)' },
      'Spanish': { flag: 'ðŸ‡ªðŸ‡¸', color: 'linear-gradient(135deg, #e96443 0%, #904e95 100%)' },
      'French': { flag: 'ðŸ‡«ðŸ‡·', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      'German': { flag: 'ðŸ‡©ðŸ‡ª', color: 'linear-gradient(135deg, #f857a6 0%, #ff5858 100%)' },
      'Japanese': { flag: 'ðŸ‡¯ðŸ‡µ', color: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)' },
      'Korean': { flag: 'ðŸ‡°ðŸ‡·', color: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)' },
      'Chinese': { flag: 'ðŸ‡¨ðŸ‡³', color: 'linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%)' },
      'Arabic': { flag: 'ðŸ‡¸ðŸ‡¦', color: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' },
      'Portuguese': { flag: 'ðŸ‡µðŸ‡¹', color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
      'Russian': { flag: 'ðŸ‡·ðŸ‡º', color: 'linear-gradient(135deg, #cfd9df 0%, #e2ebf0 100%)' },
      'Italian': { flag: 'ðŸ‡®ðŸ‡¹', color: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)' },
      'Assamese': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)' },
      'Odia': { flag: 'ðŸ‡®ðŸ‡³', color: 'linear-gradient(135deg, #8fd3f4 0%, #84fab0 100%)' },
      'Urdu': { flag: 'ðŸ‡µðŸ‡°', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' }
    };
    
    let html = `
      <div style="padding: 40px 20px 120px 20px; min-height: 100vh; background: linear-gradient(180deg, rgba(10, 14, 26, 0.5) 0%, rgba(15, 20, 25, 0.8) 100%);">
        
        <!-- Hero Header -->
        <div style="text-align: center; margin-bottom: 60px; padding: 40px 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 24px; border: 1px solid rgba(236, 72, 153, 0.2);">
          <div class="rotating-earth" style="font-size: 4rem; margin-bottom: 16px; filter: drop-shadow(0 4px 20px rgba(236, 72, 153, 0.4));">ðŸŒ</div>
          <h1 style="font-size: clamp(2rem, 5vw, 3rem); font-weight: 900; margin: 0 0 12px 0; background: linear-gradient(135deg, #667eea 0%, #ec4899 50%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            Explore Music Worldwide
          </h1>
          <p style="font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto; line-height: 1.6;">
            Discover songs from ${languages.length} different ${languages.length === 1 ? 'language' : 'languages'}. Immerse yourself in diverse musical cultures from around the globe.
          </p>
        </div>
        
        <!-- Language Cards Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; max-width: 1400px; margin: 0 auto;">
    `;
    
    // Load songs for each language and create beautiful cards
    for (const language of languages) {
      const songsResponse = await fetch(`/api/songs/by-language?language=${encodeURIComponent(language)}`);
      const languageSongs = await songsResponse.json();
      
      if (languageSongs.length === 0) continue;
      
      const langData = languageData[language] || { 
        flag: 'ðŸŒ', 
        color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
      };
      
      // Get first 4 song covers for preview
      const previewCovers = languageSongs.slice(0, 4).map(s => 
        s.coverUrl || `https://picsum.photos/400/400?random=${s._id}`
      );
      
      html += `
        <!-- Language Card -->
        <div style="background: linear-gradient(135deg, rgba(21, 25, 37, 0.95) 0%, rgba(30, 36, 53, 0.9) 100%); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; box-shadow: 0 8px 32px rgba(0,0,0,0.4);" 
             onmouseover="this.style.transform='translateY(-8px)'; this.style.borderColor='rgba(236, 72, 153, 0.5)'; this.style.boxShadow='0 12px 48px rgba(236, 72, 153, 0.3)';" 
             onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255,255,255,0.1)'; this.style.boxShadow='0 8px 32px rgba(0,0,0,0.4)';"
             onclick="document.getElementById('lang_${language.replace(/\s/g, '_')}').scrollIntoView({ behavior: 'smooth', block: 'start' });">
          
          <!-- Card Header with Gradient -->
          <div style="background: ${langData.color}; padding: 32px 24px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); pointer-events: none;"></div>
            <div style="position: relative; z-index: 1;">
              <div class="waving-flag" style="font-size: 4rem; margin-bottom: 12px; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));">${langData.flag}</div>
              <h3 style="font-size: 1.8rem; font-weight: 900; margin: 0 0 8px 0; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${language}</h3>
              <div style="display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; color: white;">
                <span>ðŸŽµ</span>
                <span>${languageSongs.length} ${languageSongs.length === 1 ? 'Song' : 'Songs'}</span>
              </div>
            </div>
          </div>
          
          <!-- Song Covers Preview Grid -->
          <div style="padding: 20px; background: rgba(0,0,0,0.2);">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
              ${previewCovers.map((cover, idx) => `
                <div style="aspect-ratio: 1; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.3); ${idx >= 2 ? 'opacity: 0.7;' : ''}">
                  <img src="${cover}" alt="Song cover" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"/>
                </div>
              `).join('')}
              ${previewCovers.length < 4 ? `
                <div style="aspect-ratio: 1; border-radius: 12px; background: rgba(236, 72, 153, 0.1); border: 2px dashed rgba(236, 72, 153, 0.3); display: flex; align-items: center; justify-content: center; font-size: 2rem; opacity: 0.5;">
                  ðŸŽµ
                </div>
              `.repeat(4 - previewCovers.length) : ''}
            </div>
            
            <div style="text-align: center; padding: 12px; background: rgba(236, 72, 153, 0.1); border-radius: 12px; border: 1px solid rgba(236, 72, 153, 0.2);">
              <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-primary);">ðŸ‘‡ Click to explore all songs</span>
            </div>
          </div>
        </div>
      `;
    }
    
    html += `
        </div>
        
        <!-- All Songs by Language (Detailed View) -->
        <div style="margin-top: 80px;">
    `;
    
    // Detailed song listings for each language
    for (const language of languages) {
      const songsResponse = await fetch(`/api/songs/by-language?language=${encodeURIComponent(language)}`);
      const languageSongs = await songsResponse.json();
      
      if (languageSongs.length === 0) continue;
      
      const langData = languageData[language] || { 
        flag: 'ðŸŒ', 
        color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
      };
      
      html += `
        <div id="lang_${language.replace(/\s/g, '_')}" style="margin-bottom: 64px; scroll-margin-top: 100px;">
          
          <!-- Section Header -->
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 32px; padding: 24px; background: ${langData.color}; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.15) 0%, transparent 60%); pointer-events: none;"></div>
            <div class="waving-flag" style="font-size: 3.5rem; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); position: relative; z-index: 1;">${langData.flag}</div>
            <div style="flex: 1; position: relative; z-index: 1;">
              <h2 style="font-size: 2rem; font-weight: 900; margin: 0 0 8px 0; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${language} Music</h2>
              <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 1rem; font-weight: 500;">${languageSongs.length} amazing ${languageSongs.length === 1 ? 'track' : 'tracks'} waiting for you</p>
            </div>
            <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; position: relative; z-index: 1;" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
              â†‘ Back to Top
            </button>
          </div>
          
          <!-- Songs Grid -->
          <div class="grid">
      `;
      
      languageSongs.forEach(song => {
        const isFavorited = (allSongs.find(s => s.id === song._id) || {}).favorited || false;
        
        html += `
          <div class="song-card">
            <div class="song-card-image" onclick="playSongById('${song._id}')">
              <img src="${song.coverUrl || 'https://picsum.photos/400/400?random=' + song._id}" alt="${song.title}" loading="lazy" />
              <div class="play-overlay">
                <div class="play-button">â–¶</div>
              </div>
            </div>
            <div class="title">${song.title}</div>
            <div class="artist">${song.artist}</div>
            <div class="song-card-footer">
              <button class="song-play-btn" onclick="playSongById('${song._id}')" title="Play">â–¶</button>
              <button class="song-favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite(event, '${song._id}')" title="Favorite">
                ${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}
              </button>
              <button class="song-favorite-btn" onclick="openAddToPlaylistModal('${song._id}')" title="Add to Playlist" style="margin-left: 4px;">
                ðŸ“‹
              </button>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
    
    html += `
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    container.dataset.loaded = 'true';
    console.log('âœ… Languages section loaded with stunning animations');
    
  } catch (error) {
    console.error('Error loading languages:', error);
    container.innerHTML = `
      <div style="padding: 60px 20px; min-height: 100vh;">
        <div class="empty-state">
          <div style="font-size: 4rem; margin-bottom: 20px;">âš ï¸</div>
          <h3>Oops! Something went wrong</h3>
          <p style="margin-bottom: 24px;">We couldn't load the languages. Please try again.</p>
          <button class="play-btn" onclick="loadLanguagesSection(); container.dataset.loaded = false;">ðŸ”„ Retry</button>
        </div>
      </div>
    `;
  }
}


// Add these functions to your <script> section in index.html

// ============================================
// FULLSCREEN PLAYER FUNCTIONS (UPDATED WITH SCROLLING & DOWNLOAD)
// ============================================

function toggleTimer() {
  // Create a simple sleep timer modal
  const timerOptions = [
    { label: '15 minutes', minutes: 15 },
    { label: '30 minutes', minutes: 30 },
    { label: '45 minutes', minutes: 45 },
    { label: '1 hour', minutes: 60 },
    { label: 'Cancel timer', minutes: 0 }
  ];
  
  // Check if timer is already active
  if (window.sleepTimer) {
    if (confirm('Sleep timer is active. Do you want to cancel it?')) {
      clearTimeout(window.sleepTimer);
      window.sleepTimer = null;
      window.sleepTimerEnd = null;
      showNotification('â± Sleep timer cancelled');
    }
    return;
  }
  
  // Create timer selection UI
  const timerHTML = timerOptions.map((option, index) => 
    `<button class="small-btn" onclick="setSleepTimer(${option.minutes})" style="width: 100%; margin-bottom: 8px;">
      ${option.minutes > 0 ? 'â±' : 'âŒ'} ${option.label}
    </button>`
  ).join('');
  
  // Show in a simple modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">â± Sleep Timer</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">Music will stop after:</p>
        ${timerHTML}
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

function setSleepTimer(minutes) {
  // Close modal
  document.querySelector('.modal-overlay')?.remove();
  
  if (minutes === 0) {
    showNotification('â± Sleep timer cancelled');
    return;
  }
  
  // Set timer
  window.sleepTimerEnd = Date.now() + (minutes * 60 * 1000);
  window.sleepTimer = setTimeout(() => {
    audioPlayer.pause();
    isPlaying = false;
    updatePlayPauseButton();
    showNotification('â± Sleep timer ended - Music paused');
    window.sleepTimer = null;
    window.sleepTimerEnd = null;
  }, minutes * 60 * 1000);
  
  showNotification(`â± Sleep timer set for ${minutes} minutes`);
}

function shareCurrentSong() {
  if (currentSongIndex === -1) {
    showNotification('âš ï¸ No song is currently playing');
    return;
  }
  
  const song = songs[currentSongIndex];
  
  // Create shareable text
  const shareText = `ðŸŽµ Now listening to "${song.title}" by ${song.artist} on VibeSync`;
  const shareUrl = window.location.origin;
  
  // Check if Web Share API is available (mobile devices)
  if (navigator.share) {
    navigator.share({
      title: 'VibeSync - ' + song.title,
      text: shareText,
      url: shareUrl
    }).then(() => {
      showNotification('ðŸ”— Shared successfully!');
    }).catch((error) => {
      // User cancelled or error occurred
      if (error.name !== 'AbortError') {
        fallbackShare(song, shareText);
      }
    });
  } else {
    // Fallback for desktop browsers
    fallbackShare(song, shareText);
  }
}

function fallbackShare(song, shareText) {
  // Create share modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">ðŸ”— Share Song</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px; max-height: 600px; overflow-y: auto;">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
          <img src="${song.img}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;" />
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 700; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis;">${song.title}</div>
            <div style="font-size: 14px; color: var(--text-secondary);">${song.artist}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Share Text</label>
          <textarea id="shareText" class="form-input form-textarea" readonly style="min-height: 80px;">${shareText}</textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
          <button class="btn btn-primary" onclick="copyShareText()">
            ðŸ“‹ Copy Text
          </button>
          <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
            Close
          </button>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">Share on social media:</p>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="small-btn" onclick="shareToWhatsApp('${encodeURIComponent(shareText)}')">
              ðŸ’¬ WhatsApp
            </button>
            <button class="small-btn" onclick="shareToTwitter('${encodeURIComponent(shareText)}')">
              ðŸ¦ Twitter
            </button>
            <button class="small-btn" onclick="shareToFacebook()">
              ðŸ‘ Facebook
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

function copyShareText() {
  const textarea = document.getElementById('shareText');
  textarea.select();
  document.execCommand('copy');
  showNotification('ðŸ“‹ Copied to clipboard!');
}

function shareToWhatsApp(text) {
  window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareToTwitter(text) {
  window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
}

function shareToFacebook() {
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.origin)}`, '_blank');
}

function openQueue() {
  if (songs.length === 0) {
    showNotification('âš ï¸ No songs in queue');
    return;
  }
  
  // Create queue modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  
  let queueHTML = '';
  songs.forEach((song, index) => {
    const isCurrentSong = index === currentSongIndex;
    queueHTML += `
      <div class="playlist-item ${isCurrentSong ? 'style="background: rgba(236, 72, 153, 0.1); border-color: var(--accent-primary);"' : ''}" 
           onclick="playSongById('${song.id}')">
        <img src="${song.img}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover; margin-right: 12px;" />
        <div class="playlist-item-info">
          <div class="playlist-item-name">${song.title}</div>
          <div class="playlist-item-meta">${song.artist}</div>
        </div>
        ${isCurrentSong ? '<span style="color: var(--accent-primary); font-size: 20px;">â–¶</span>' : '<span style="color: var(--text-muted); font-size: 16px;">â™ª</span>'}
      </div>
    `;
  });
  
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">â˜° Current Queue</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">
          ${songs.length} ${songs.length === 1 ? 'song' : 'songs'} in queue
        </p>
        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
          ${queueHTML}
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="width: 100%;">
            Close Queue
          </button>
        </div>
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
  
  // Scroll to current song if exists
  if (currentSongIndex !== -1) {
    setTimeout(() => {
      const currentItem = modal.querySelector('.playlist-item[style*="rgba(236, 72, 153, 0.1)"]');
      if (currentItem) {
        currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  }
}

// Connect button functionality (for future features)
function connectDevice() {
  showNotification('ðŸ“± Device connect feature coming soon!');
}

// Make sure the fullscreen menu button also has functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add click handler to fullscreen menu button
  const fullscreenMenu = document.querySelector('.fullscreen-menu');
  if (fullscreenMenu) {
    fullscreenMenu.onclick = function() {
      showFullscreenMenu();
    };
  }
});

function showFullscreenMenu() {
  if (currentSongIndex === -1) {
    showNotification('âš ï¸ No song is currently playing');
    return;
  }
  
  const song = songs[currentSongIndex];
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">â‹® Song Options</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px; max-height: 600px; overflow-y: auto;">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
          <img src="${song.img}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;" />
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 700; margin-bottom: 4px;">${song.title}</div>
            <div style="font-size: 14px; color: var(--text-secondary);">${song.artist}</div>
          </div>
        </div>
        
        <button class="small-btn" onclick="downloadSong('${song.id}'); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          â¬‡ï¸ Download Song
        </button>
        
        <button class="small-btn" onclick="openAddToPlaylistModal('${song.id}'); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          ðŸ“‹ Add to Playlist
        </button>
        
        <button class="small-btn" onclick="toggleFavorite(event, '${song.id}'); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          ${song.favorited ? 'â¤ï¸ Remove from Favorites' : 'ðŸ¤ Add to Favorites'}
        </button>
        
        <button class="small-btn" onclick="shareCurrentSong(); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          ðŸ”— Share Song
        </button>
        
        <button class="small-btn" onclick="openQueue(); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          â˜° View Queue
        </button>
        
        <button class="small-btn" onclick="showSongInfo('${song.id}'); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
          â„¹ï¸ Song Info
        </button>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="width: 100%;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

function showSongInfo(songId) {
  const song = songs.find(s => s.id === songId);
  if (!song) {
    showNotification('âš ï¸ Song not found');
    return;
  }
  
  const emotionsList = song.emotions ? song.emotions.map(e => {
    const emojiMap = {
      'happy': 'ðŸ˜Š', 'sad': 'ðŸ˜¢', 'angry': 'ðŸ˜ ', 
      'surprise': 'ðŸ˜²', 'fear': 'ðŸ˜¨', 'disgust': 'ðŸ¤¢', 'neutral': 'ðŸ˜'
    };
    return `<span style="display: inline-block; padding: 4px 12px; background: rgba(236, 72, 153, 0.1); border-radius: 16px; margin: 4px; font-size: 14px;">${emojiMap[e.toLowerCase()] || 'ðŸŽµ'} ${e}</span>`;
  }).join('') : 'Not specified';
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">â„¹ï¸ Song Information</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px; max-height: 600px; overflow-y: auto;">
        <div style="text-align: center; margin-bottom: 24px;">
          <img src="${song.img}" style="width: 200px; height: 200px; border-radius: 16px; object-fit: cover; box-shadow: var(--shadow-lg); margin: 0 auto;" />
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Title</div>
          <div style="font-size: 18px; font-weight: 700;">${song.title}</div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Artist</div>
          <div style="font-size: 16px; font-weight: 600;">${song.artist}</div>
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Emotions</div>
          <div>${emotionsList}</div>
        </div>
        
        ${song.language ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px;">Language</div>
            <div style="font-size: 16px;">${song.language}</div>
          </div>
        ` : ''}
        
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button class="btn btn-primary" onclick="playSongById('${song.id}'); document.querySelector('.modal-overlay')?.remove();" style="width: 100%; margin-bottom: 8px;">
            â–¶ Play Now
          </button>
          <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="width: 100%;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

// ============================================
// DOWNLOAD SONG FUNCTION (NEW)
// ============================================

function downloadSong(songId) {
  const song = songs.find(s => s.id === songId);
  if (!song) {
    showNotification('âš ï¸ Song not found');
    return;
  }
  
  if (!song.audioUrl) {
    showNotification('âš ï¸ Audio file not available for download');
    return;
  }
  
  // Show download confirmation modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">â¬‡ï¸ Download Song</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–</button>
      </div>
      <div style="padding: 20px; max-height: 600px; overflow-y: auto;">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
          <img src="${song.img}" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;" />
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;">${song.title}</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">${song.artist}</div>
            <div style="font-size: 12px; color: var(--text-muted);">
              ${song.language ? `ðŸŒ ${song.language} â€¢ ` : ''}ðŸŽµ MP3 Format
            </div>
          </div>
        </div>
        
        <div style="background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="font-size: 24px;">ðŸ“¥</span>
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">Ready to Download</div>
              <div style="font-size: 13px; color: var(--text-secondary);">This song will be saved to your device</div>
            </div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="startDownload('${song.id}', '${encodeURIComponent(song.title)}', '${encodeURIComponent(song.artist)}')">
            â¬‡ï¸ Download
          </button>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <p style="font-size: 12px; color: var(--text-muted); line-height: 1.5;">
            ðŸ“Œ Note: Downloaded songs are for personal use only. Please respect copyright laws and support the artists.
          </p>
        </div>
      </div>
    </div>
  `;
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
}

async function startDownload(songId, encodedTitle, encodedArtist) {
  const song = songs.find(s => s.id === songId);
  if (!song || !song.audioUrl) {
    showNotification('âš ï¸ Download failed - Audio not available');
    return;
  }
  
  // Close modal
  document.querySelector('.modal-overlay')?.remove();
  
  // Show downloading notification
  showNotification('â¬‡ï¸ Starting download...');
  
  try {
    // Fetch the audio file
    const response = await fetch(song.audioUrl);
    const blob = await response.blob();
    
    // Create download link
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    
    // Create filename
    const title = decodeURIComponent(encodedTitle);
    const artist = decodeURIComponent(encodedArtist);
    const filename = `${artist} - ${title}.mp3`.replace(/[/\\?%*:|"<>]/g, '-');
    a.download = filename;
    
    // Trigger download
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);
    
    showNotification('âœ… Download started successfully!');
    
  } catch (error) {
    console.error('Download error:', error);
    
    // Fallback: Open in new tab if fetch fails
    window.open(song.audioUrl, '_blank');
    showNotification('ðŸ“‚ Opening audio in new tab...');
  }
}

// Update the Connect button in fullscreen-bottom-controls
document.addEventListener('DOMContentLoaded', function() {
  const connectBtn = document.querySelector('.bottom-control-btn[title="Connect"]');
  if (connectBtn) {
    connectBtn.onclick = connectDevice;
  }
});






  </script>
</body>
</html>